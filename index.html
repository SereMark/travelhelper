<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Traveler Vision — Math Solver</title>
<style>
:root{--bg:#fff;--fg:#111;--accent:#4f46e5}@media(prefers-color-scheme:dark){:root{--bg:#121212;--fg:#eee;--accent:#6366f1}}
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
body{display:flex;flex-direction:column;gap:1rem;height:100vh;padding:1rem;background:var(--bg);color:var(--fg)}
header{font:600 1.3rem/1 inherit;text-align:center}
input,select,button{font:1rem/1 inherit;padding:.75rem;border-radius:8px;border:1px solid #ccc;background:var(--bg);color:var(--fg)}
button{background:var(--accent);color:#fff;border:none}
button:disabled{opacity:.55}
.preview{width:100%;aspect-ratio:3/4}
video{width:100%;height:100%;border-radius:8px;background:#000;object-fit:contain}
#log{font-size:1rem;line-height:1.45;max-height:45vh;overflow:auto;background:rgba(0,0,0,.06);padding:.8rem;border-radius:8px}
footer{display:flex;gap:.9rem}
.control{display:flex;flex-direction:column;gap:.35rem;margin-top:1rem}
label{font-size:.9rem;opacity:.85}
</style>
</head>
<body>
<header>Traveler Vision · Math</header>
<div id="auth"><input id="key" type="password" placeholder="OpenAI key"><div style="display:flex;gap:.7rem;margin-top:.7rem"><button id="save">Save</button><button id="clear" disabled>Clear</button></div></div>
<select id="cam" hidden></select>
<div id="ctrls" hidden>
  <div class="control" id="zBlk" hidden><label>Zoom <output id="zOut">1</output>×</label><input id="zoom" type="range" min="1" max="12" step="0.1"></div>
  <div class="control" id="fBlk" hidden><label>Focus <output id="fOut">auto</output></label><input id="focus" type="range" step="0.01"></div>
</div>
<div class="preview"><video id="view" autoplay muted playsinline></video></div>
<pre id="log" title="double‑tap to expand"></pre>
<footer><button id="start" disabled>Start</button><button id="stop" disabled>Stop</button></footer>
<script>
(()=>{
const $=id=>document.getElementById(id);
let key=localStorage.getItem("TV_KEY")||"";
let stream=null,track=null,run=false,timer=null,hwZoomMax=1,digital=1;
/* ─── UI helpers ─── */
const log=t=>{$("log").textContent=`${new Date().toLocaleTimeString()} — ${t}\n`+$("log").textContent};
const ui=()=>{$("key").disabled=!!key;$("save").disabled=!!key;$("clear").disabled=!key;$("start").disabled=!track||!key||run;$("stop").disabled=!run;$("cam").hidden=!track;$("ctrls").hidden=!track};
/* ─── Camera enumeration ─── */
async function listCams(){const dev=await navigator.mediaDevices.enumerateDevices();const cams=dev.filter(d=>d.kind==="videoinput");$("cam").innerHTML="";cams.forEach(c=>{const o=document.createElement("option");o.value=c.deviceId;o.textContent=c.label||"camera";$("cam").appendChild(o);});$("cam").hidden=!cams.length;$("cam").onchange=startCam;}
/* ─── Camera start ─── */
async function startCam(){if(stream)stream.getTracks().forEach(t=>t.stop());const id=$("cam").value||undefined;try{stream=await navigator.mediaDevices.getUserMedia({video:id?{deviceId:{exact:id},width:{ideal:1024}}:{facingMode:"environment",width:{ideal:1024}}});track=stream.getVideoTracks()[0];$("view").srcObject=stream;log(`Lens selected: ${track.label||""}`);setupPTZ();}catch(e){log(`Camera error: ${e.message}`);}ui();}
/* ─── PTZ setup ─── */
function setupPTZ(){const cap=track.getCapabilities(),set=track.getSettings();if(cap.zoom){$("zBlk").hidden=false;hwZoomMax=cap.zoom.max;$("zoom").value=set.zoom||1;$("zOut").textContent=$("zoom").value;}else{$("zBlk").hidden=true;hwZoomMax=1;}if(cap.focusMode&&cap.focusMode.includes("manual")&&cap.focusDistance){$("fBlk").hidden=false;$("focus").min=cap.focusDistance.min;$("focus").max=cap.focusDistance.max;$("focus").step=cap.focusDistance.step||0.01;$("focus").value=set.focusDistance||cap.focusDistance.min;$("fOut").textContent=$("focus").value;}else{$("fBlk").hidden=true;}}
async function applyPTZ(){const z=parseFloat($("zoom").value);$("zOut").textContent=z;digital=z>hwZoomMax?z/hwZoomMax:1;if(z<=hwZoomMax){try{await track.applyConstraints({advanced:[{zoom:z}]});}catch(e){log(`Zoom‑constraint err: ${e.message}`);} }
if(!$("fBlk").hidden){const f=parseFloat($("focus").value);$("fOut").textContent=f;try{await track.applyConstraints({advanced:[{focusMode:"manual",focusDistance:f}]});}catch(e){log(`Focus err: ${e.message}`);} }}
$("zoom").oninput=applyPTZ;$("focus").oninput=applyPTZ;
/* ─── Capture loop ─── */
function plan(){clearTimeout(timer);if(run)timer=setTimeout(capture,3300);} 
async function capture(){const v=$("view");if(!v.videoWidth){plan();return;}await applyPTZ();const portrait=v.videoWidth<v.videoHeight;const srcW=portrait?v.videoHeight/digital:v.videoWidth/digital;const srcH=portrait?v.videoWidth/digital:v.videoHeight/digital;const cx=v.videoWidth/2,cy=v.videoHeight/2;const can=document.createElement("canvas");can.width=portrait?v.videoHeight:v.videoWidth;can.height=portrait?v.videoWidth:v.videoHeight;const ctx=can.getContext("2d");ctx.save();if(portrait){ctx.translate(can.width/2,can.height/2);ctx.rotate(Math.PI/2);ctx.translate(-can.height/2,-can.width/2);}ctx.drawImage(v,cx-srcW/2,cy-srcH/2,srcW,srcH,0,0,can.width,can.height);ctx.restore();try{const answer=await solveImage(can.toDataURL("image/jpeg",0.9));log(`Answer: ${answer}`);try{speechSynthesis.speak(new SpeechSynthesisUtterance(answer));}catch{}}catch(e){log(`AI fail: ${e.message}`);}plan();}
/* ─── Robust OpenAI call ─── */
async function solveImage(b64){const prompt="Solve the math problem in the image. Think step by step. Return ONLY the numeric answer on the last line.";const attempt=async(eff)=>{const body={model:"o4-mini",max_completion_tokens:eff==='medium'?512:768,reasoning_effort:eff,messages:[{role:"user",content:[{type:"text",text:prompt},{type:"image_url",image_url:{url:b64,detail:"high"}}]}]};const res=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${key}`},body:JSON.stringify(body)});if(!res.ok){const txt=await res.text();throw new Error(`HTTP ${res.status}: ${txt}`);}return res.json();};
for(const eff of["medium","high"]){try{log(`Querying o4‑mini (${eff}) …`);const j=await attempt(eff);const txt=j.choices?.[0]?.message?.content?.trim()||"";log(`Raw: ${txt}`);if(/\d/.test(txt)&&!/^sorry/i.test(txt))return txt.split(/\n/).pop();}catch(e){log(`Attempt ${eff} error: ${e.message}`);}await new Promise(r=>setTimeout(r,900));}
throw new Error("o4‑mini failed after 2 efforts");}
/* ─── Buttons ─── */
$("save").onclick=()=>{key=$("key").value.trim();if(!key)return;localStorage.setItem("TV_KEY",key);$("key").value="********";listCams().then(startCam);ui();};
$("clear").onclick=()=>{localStorage.removeItem("TV_KEY");key="";if(stream)stream.getTracks().forEach(t=>t.stop());track=null;$("cam").hidden=$("ctrls").hidden=true;ui();$("key").value="";};
$("start").onclick=()=>{if(!track||!key)return;run=true;capture();ui();};
$("stop").onclick=()=>{run=false;plan();ui();};
/* log expand */
let big=false;$("log").ondblclick=()=>{big=!big;$("log").style.maxHeight=big?"85vh":"45vh";};
/* init */
if(key){$("key").value="********";listCams().then(startCam);}ui();
})();
</script>
</body>
</html>
