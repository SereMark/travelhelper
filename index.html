<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Traveler Vision</title>

  <style>
    :root{
      --bg:#fff;--fg:#111;--accent:#4f46e5;--accent-dk:#3f3ccb;--danger:#d9534f;
    }
    @media(prefers-color-scheme:dark){
      :root{--bg:#1e1e1e;--fg:#eee;--accent:#6366f1;--accent-dk:#4b4fe1}
    }
    *{box-sizing:border-box;margin:0;padding:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,
      Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif}
    body{display:flex;flex-direction:column;height:100vh;background:var(--bg);
         color:var(--fg);padding:1rem;gap:1rem}

    header{font-size:1.25rem;font-weight:600;text-align:center}
    input,button{font-size:1rem;padding:.7rem;border-radius:6px;
                 border:1px solid #ccc;background:var(--bg);color:var(--fg)}
    button{background:var(--accent);border:none;color:#fff}
    button:disabled{opacity:.5}
    video{width:100%;border-radius:8px;background:#000;aspect-ratio:4/3}
    #log{flex:1;overflow:auto;font-size:.8rem;line-height:1.4;
         background:rgba(0,0,0,.05);padding:.5rem;border-radius:6px}
    footer{display:flex;gap:.5rem}
  </style>
</head>

<body>
  <header>Traveler Vision</header>

  <!-- API-key block -->
  <div id="auth">
    <input id="key" type="password" placeholder="OpenAI key">
    <div style="display:flex;gap:.5rem;margin-top:.5rem">
      <button id="save">Save</button>
      <button id="clear" disabled>Clear</button>
    </div>
  </div>

  <!-- live view -->
  <video id="view" autoplay muted playsinline></video>

  <!-- transcript / status -->
  <pre id="log"></pre>

  <!-- controls -->
  <footer>
    <button id="start" disabled>Start</button>
    <button id="stop"  disabled>Stop</button>
  </footer>

<script>
(()=>{
  /* ---------- helpers ---------- */
  const $ = id => document.getElementById(id);
  const S = { key: localStorage.getItem("TV_KEY")||"", stream:null,
              running:false, timer:null };

  const log = txt=>{
    $("log").textContent =
      new Date().toLocaleTimeString()+" â€” "+txt+"\n"+$("log").textContent;
  };

  const ui = ()=>{
    $("key").disabled = !!S.key;
    $("save").disabled = !!S.key;
    $("clear").disabled = !S.key;
    $("start").disabled = !S.stream || !S.key || S.running;
    $("stop").disabled  = !S.running;
  };

  /* ---------- OpenAI call ---------- */
  const ask = async dataUrl=>{
    const payload = {
      model: "o4-mini",
      messages: [{
        role:"user",
        content:[
          {type:"text",
           text:"Identify the solution in the image and return the identifier "+
                "three times separated by spaces."},
          {type:"image_url",image_url:{url:dataUrl,detail:"low"}}
        ]
      }],
      max_tokens: 60,
      temperature: 0
    };

    const res = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        Authorization:`Bearer ${S.key}`
      },
      body:JSON.stringify(payload)
    });
    const json = await res.json();
    if(!res.ok) throw Error(json.error?.message||res.status);
    return json.choices[0].message.content.trim();
  };

  /* ---------- camera ---------- */
  const startCam = async()=>{
    try{
      S.stream = await navigator.mediaDevices.getUserMedia({
        video:{facingMode:"environment",width:{ideal:640}}
      });
      $("view").srcObject = S.stream;
      log("Camera ready");
    }catch(e){
      log("Camera error: "+e.message);
    }
    ui();
  };

  const stopCam = ()=>{
    if(S.stream){ S.stream.getTracks().forEach(t=>t.stop()); }
    S.stream=null; ui();
  };

  /* ---------- capture loop ---------- */
  const plan = ()=>{
    clearTimeout(S.timer);
    if(S.running) S.timer = setTimeout(capture,4000);
  };

  const capture = async()=>{
    const v = $("view");
    if(!v.videoWidth){ plan(); return; }

    const c = document.createElement("canvas");
    c.width = v.videoWidth; c.height = v.videoHeight;
    c.getContext("2d").drawImage(v,0,0,c.width,c.height);

    try{
      const reply = await ask(c.toDataURL("image/jpeg",.8));
      log(reply);
      /* browsers require a user gesture before speech is allowed */
      try{ speechSynthesis.speak(new SpeechSynthesisUtterance(reply)); }
      catch(_){}  // silently ignore autoplay-policy blocks
    }catch(e){ log("Error: "+e.message); }

    plan();
  };

  /* ---------- button handlers ---------- */
  $("save").onclick = ()=>{
    S.key = $("key").value.trim();
    if(!S.key) return;
    localStorage.setItem("TV_KEY",S.key);
    $("key").value = "********";
    startCam();
  };

  $("clear").onclick = ()=>{
    localStorage.removeItem("TV_KEY");
    S.key=""; stopCam(); ui();
    $("key").value="";
  };

  $("start").onclick = ()=>{
    if(!S.stream||!S.key) return;
    S.running=true; capture(); ui();
  };

  $("stop").onclick = ()=>{
    S.running=false; plan(); ui();
  };

  /* ---------- keyboard shortcut for testers ---------- */
  document.addEventListener("keydown",e=>{
    if(e.altKey&&e.key==="a"){ S.running?$("stop").click():$("start").click(); }
  });

  /* ---------- init on load ---------- */
  if(S.key){ $("key").value="********"; startCam(); }
  ui();
})();
</script>
</body>
</html>