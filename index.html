<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Traveler Vision — Math Solver</title>
<style>
:root{--bg:#fff;--fg:#111;--accent:#4f46e5}@media(prefers-color-scheme:dark){:root{--bg:#121212;--fg:#eee;--accent:#6366f1}}
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
body{display:flex;flex-direction:column;gap:1rem;height:100vh;padding:1rem;background:var(--bg);color:var(--fg)}
header{font:600 1.3rem/1 inherit;text-align:center}
input,select,button{font:1rem/1 inherit;padding:.75rem;border-radius:8px;border:1px solid #ccc;background:var(--bg);color:var(--fg)}
button{background:var(--accent);color:#fff;border:none}
button:disabled{opacity:.55}
.preview{width:100%;aspect-ratio:3/4}
video{width:100%;height:100%;border-radius:8px;background:#000;object-fit:contain}
#log{font-size:1rem;line-height:1.4;max-height:40vh;overflow:auto;background:rgba(0,0,0,.06);padding:.75rem;border-radius:8px}
footer{display:flex;gap:.8rem}
.control{display:flex;flex-direction:column;gap:.35rem;margin-top:.9rem}
label{font-size:.9rem;opacity:.85}
</style>
</head>
<body>
<header>Traveler Vision · Math</header>
<div id="auth"><input id="key" type="password" placeholder="OpenAI key"><div style="display:flex;gap:.6rem;margin-top:.6rem"><button id="save">Save</button><button id="clear" disabled>Clear</button></div></div>
<select id="cam" hidden></select>
<div id="ctrls" hidden>
  <div class="control" id="zBlk" hidden><label>Zoom <output id="zOut">1</output>×</label><input id="zoom" type="range" min="1" max="12" step="0.1"></div>
  <div class="control" id="fBlk" hidden><label>Focus <output id="fOut">auto</output></label><input id="focus" type="range" step="0.01"></div>
</div>
<div class="preview"><video id="view" autoplay muted playsinline></video></div>
<pre id="log" title="double‑tap to expand"></pre>
<footer><button id="start" disabled>Start</button><button id="stop" disabled>Stop</button></footer>
<script>
(()=>{
const $=id=>document.getElementById(id);
let stream=null,track=null,run=false,timer=null,hwMaxZoom=1,digMult=1,key=localStorage.getItem("TV_KEY")||"";
/* util */
const log=t=>{$("log").textContent=`${new Date().toLocaleTimeString()} — ${t}\n`+$("log").textContent};
const ui=()=>{$("key").disabled=!!key;$("save").disabled=!!key;$("clear").disabled=!key;$("start").disabled=!track||!key||run;$("stop").disabled=!run;$("cam").hidden=!track;$("ctrls").hidden=!track};
/* camera list */
async function listCams(){const d=await navigator.mediaDevices.enumerateDevices();const cams=d.filter(x=>x.kind==="videoinput");$("cam").innerHTML="";cams.forEach(c=>{const o=document.createElement("option");o.value=c.deviceId;o.textContent=c.label||"camera";$("cam").appendChild(o);});$("cam").hidden=!cams.length;$("cam").onchange=startCam;}
/* start selected camera */
async function startCam(){if(stream)stream.getTracks().forEach(t=>t.stop());const id=$("cam").value||undefined;try{stream=await navigator.mediaDevices.getUserMedia({video:id?{deviceId:{exact:id},width:{ideal:1024}}:{facingMode:"environment",width:{ideal:1024}}});track=stream.getVideoTracks()[0];$("view").srcObject=stream;log(`Lens: ${track.label||""}`);setupPTZ();}catch(e){log(`Cam error: ${e.message}`);}ui();}
/* PTZ */
function setupPTZ(){const c=track.getCapabilities(),s=track.getSettings();if(c.zoom){$("zBlk").hidden=false;hwMaxZoom=c.zoom.max;$("zoom").value=s.zoom||1;$("zOut").textContent=$("zoom").value;}else{$("zBlk").hidden=true;hwMaxZoom=1;}if(c.focusMode&&c.focusMode.includes("manual")&&c.focusDistance){$("fBlk").hidden=false;$("focus").min=c.focusDistance.min;$("focus").max=c.focusDistance.max;$("focus").step=c.focusDistance.step||0.01;$("focus").value=s.focusDistance||c.focusDistance.min;$("fOut").textContent=$("focus").value;}else{$("fBlk").hidden=true;}}
async function applyPTZ(){const tasks=[];const z=parseFloat($("zoom").value);$("zOut").textContent=z;digMult=z>hwMaxZoom?z/hwMaxZoom:1;if(z<=hwMaxZoom)tasks.push(track.applyConstraints({advanced:[{zoom:z}]}));if(!$("fBlk").hidden){const f=parseFloat($("focus").value);$("fOut").textContent=f;tasks.push(track.applyConstraints({advanced:[{focusMode:"manual",focusDistance:f}]}));}await Promise.allSettled(tasks);}$("zoom").oninput=applyPTZ;$("focus").oninput=applyPTZ;
/* capture */
function plan(){clearTimeout(timer);if(run)timer=setTimeout(capture,3500);}
async function capture(){const v=$("view");if(!v.videoWidth){plan();return;}await applyPTZ();const portrait=v.videoWidth<v.videoHeight;const srcW=portrait?v.videoHeight/digMult:v.videoWidth/digMult;const srcH=portrait?v.videoWidth/digMult:v.videoHeight/digMult;const cx=v.videoWidth/2,cy=v.videoHeight/2;const can=document.createElement("canvas");can.width=portrait?v.videoHeight:v.videoWidth;can.height=portrait?v.videoWidth:v.videoHeight;const ctx=can.getContext("2d");ctx.save();if(portrait){ctx.translate(can.width/2,can.height/2);ctx.rotate(Math.PI/2);ctx.translate(-can.height/2,-can.width/2);}ctx.drawImage(v,cx-srcW/2,cy-srcH/2,srcW,srcH,0,0,can.width,can.height);ctx.restore();try{const ans=await solveImage(can.toDataURL("image/jpeg",0.85));log(ans);try{speechSynthesis.speak(new SpeechSynthesisUtterance(ans));}catch{}}catch(e){log(e.message);}plan();}
/* OpenAI robust helper */
async function solveImage(b64){const make=(effort)=>({model:"o4-mini",max_completion_tokens:512,reasoning_effort:effort,messages:[{role:"user",content:[{type:"text",text:"Solve the math problem in the image. Think step by step. Return ONLY the numeric answer on the last line."},{type:"image_url",image_url:{url:b64,detail:"high"}}]}]});for(const eff of["medium","high"]){const r=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${key}`},body:JSON.stringify(make(eff))}).then(x=>x.json());const t=r?.choices?.[0]?.message?.content?.trim()||"";if(/\d/.test(t)&&!/^sorry/i.test(t))return t.split(/\n/).pop();await new Promise(res=>setTimeout(res,800));}throw new Error("o4‑mini failed after retries");}
/* buttons */
$("save").onclick=()=>{key=$("key").value.trim();if(!key)return;localStorage.setItem("TV_KEY",key);$("key").value="********";listCams().then(startCam);ui();};
$("clear").onclick=()=>{localStorage.removeItem("TV_KEY");key="";if(stream)stream.getTracks().forEach(t=>t.stop());track=null;$("cam").hidden=$("ctrls").hidden=true;ui();$("key").value="";};
$("start").onclick=()=>{if(!track||!key)return;run=true;capture();ui();};
$("stop").onclick=()=>{run=false;plan();ui();};
/* log expand */
let big=false;$("log").ondblclick=()=>{big=!big;$("log").style.maxHeight=big?"80vh":"40vh";};
/* init */
if(key){$("key").value="********";listCams().then(startCam);}ui();
})();
</script>
</body>
</html>