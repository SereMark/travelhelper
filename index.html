<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Traveler Vision</title>
<style>
:root{--bg:#fff;--fg:#111;--accent:#4f46e5}
@media(prefers-color-scheme:dark){
  :root{--bg:#1e1e1e;--fg:#eee;--accent:#6366f1}}
*{box-sizing:border-box;margin:0;padding:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
body{display:flex;flex-direction:column;height:100vh;padding:1rem;gap:1rem;
     background:var(--bg);color:var(--fg)}
header{font-size:1.25rem;font-weight:600;text-align:center}
input,select,button{font-size:1rem;padding:.7rem;border-radius:6px;
                    border:1px solid #ccc;background:var(--bg);color:var(--fg)}
button{background:var(--accent);border:none;color:#fff}
button:disabled{opacity:.5}
.preview{width:100%;aspect-ratio:3/4}
video{width:100%;height:100%;border-radius:8px;background:#000;object-fit:contain}
#log{flex:1;overflow:auto;font-size:.8rem;background:rgba(0,0,0,.05);
     padding:.6rem;border-radius:6px}
footer{display:flex;gap:.5rem}
.control{display:flex;flex-direction:column;gap:.3rem;margin-top:.8rem}
label{font-size:.85rem;opacity:.9}
</style>
</head>

<body>
<header>Traveler Vision</header>

<div id="auth">
  <input id="key" type="password" placeholder="OpenAI key">
  <div style="display:flex;gap:.5rem;margin-top:.5rem">
    <button id="save">Save</button>
    <button id="clear" disabled>Clear</button>
  </div>
</div>

<select id="camSelect" hidden></select>

<div id="controls" hidden>
  <div class="control" id="zoomBlock" hidden>
    <label>Zoom <output id="zoomVal">1</output>×</label>
    <input type="range" id="zoom" step="0.1">
  </div>
  <div class="control" id="focusBlock" hidden>
    <label>Focus <output id="focusVal">auto</output></label>
    <input type="range" id="focus" step="0.01">
  </div>
</div>

<div class="preview"><video id="view" autoplay muted playsinline></video></div>
<pre id="log"></pre>

<footer>
  <button id="start" disabled>Start</button>
  <button id="stop"  disabled>Stop</button>
</footer>

<script>
(()=>{
const $=id=>document.getElementById(id);
const S={key:localStorage.getItem("TV_KEY")||"",stream:null,track:null,
         running:false,timer:null};

const log=t=>{$("log").textContent=
  new Date().toLocaleTimeString()+" — "+t+"\n"+$("log").textContent};

const ui=()=>{
  $("key").disabled=!!S.key; $("save").disabled=!!S.key;
  $("clear").disabled=!S.key;
  $("start").disabled=!S.track||!S.key||S.running;
  $("stop").disabled=!S.running;
  $("camSelect").hidden=!S.track; $("controls").hidden=!S.track;
};

const populateCams=async()=>{
  const d=await navigator.mediaDevices.enumerateDevices();
  const cams=d.filter(x=>x.kind==="videoinput");
  $("camSelect").innerHTML="";
  cams.forEach(c=>{
    const o=document.createElement("option");
    o.value=c.deviceId; o.textContent=c.label||"Camera";
    $("camSelect").appendChild(o);
  });
  if(cams.length){$("camSelect").hidden=false;$("camSelect").onchange=startCam;}
};

const startCam=async()=>{
  if(S.stream) S.stream.getTracks().forEach(t=>t.stop());
  const id=$("camSelect").value||undefined;
  try{
    S.stream=await navigator.mediaDevices.getUserMedia({
      video:id?{deviceId:{exact:id}}:{facingMode:"environment"}});
    S.track=S.stream.getVideoTracks()[0];
    $("view").srcObject=S.stream;
    log("Lens: "+(S.track.label||""));
    setupPTZ();
  }catch(e){log("Camera error: "+e.message)}
  ui();
};

const setupPTZ=()=>{
  const cap=S.track.getCapabilities(); const set=S.track.getSettings();

  if(cap.zoom){
    $("zoomBlock").hidden=false;
    $("zoom").min=cap.zoom.min; $("zoom").max=cap.zoom.max;
    $("zoom").step=cap.zoom.step||0.1;
    $("zoom").value=set.zoom||cap.zoom.min;
    $("zoomVal").textContent=$("zoom").value;
    $("zoom").oninput=async e=>{
      const v=parseFloat(e.target.value);$("zoomVal").textContent=v;
      try{await S.track.applyConstraints({advanced:[{zoom:v}]});}
      catch(err){log("Zoom error: "+err.message);}
    };
  }else{$("zoomBlock").hidden=true}

  if(cap.focusMode&&cap.focusMode.includes("manual")&&cap.focusDistance){
    $("focusBlock").hidden=false;
    $("focus").min=cap.focusDistance.min; $("focus").max=cap.focusDistance.max;
    $("focus").step=cap.focusDistance.step||0.01;
    $("focus").value=set.focusDistance||cap.focusDistance.min;
    $("focusVal").textContent=$("focus").value;
    $("focus").oninput=async e=>{
      const v=parseFloat(e.target.value);$("focusVal").textContent=v;
      try{
        await S.track.applyConstraints(
          {advanced:[{focusMode:"manual",focusDistance:v}]});
      }catch(err){log("Focus error: "+err.message);}
    };
  }else{$("focusBlock").hidden=true}
};

const plan=()=>{clearTimeout(S.timer);
  if(S.running) S.timer=setTimeout(capture,4000);};

const capture=async()=>{
  const v=$("view");if(!v.videoWidth){plan();return;}
  const c=document.createElement("canvas");
  c.width=v.videoWidth; c.height=v.videoHeight;
  c.getContext("2d").drawImage(v,0,0,c.width,c.height);
  try{
    const res=await ask(c.toDataURL("image/jpeg",.8));
    log(res); try{speechSynthesis.speak(new SpeechSynthesisUtterance(res));}catch(_){}
  }catch(e){log("AI error: "+e.message);}
  plan();
};

const ask=async dataUrl=>{
  const payload={
    model:"o4-mini",
    messages:[{
      role:"user",
      content:[
        {type:"text",
         text:"Solve the following problem. Think step by step and show all "+
              "reasoning. Then RETURN ONLY the final numeric answer on the "+
              "last line.\n\nProblem image follows."},
        {type:"image_url",image_url:{url:dataUrl,detail:"high"}}
      ]}],
    max_completion_tokens:512,
    reasoning_effort:"high"
  };
  const r=await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{"Content-Type":"application/json",
             Authorization:`Bearer ${S.key}`},
    body:JSON.stringify(payload)});
  const j=await r.json();
  if(!r.ok) throw Error(j.error?.message||r.status);
  return j.choices[0].message.content.trim();
};

/* buttons */
$("save").onclick=()=>{S.key=$("key").value.trim();if(!S.key)return;
  localStorage.setItem("TV_KEY",S.key);$("key").value="********";
  populateCams().then(startCam);ui();};
$("clear").onclick=()=>{localStorage.removeItem("TV_KEY");S.key="";
  if(S.stream)S.stream.getTracks().forEach(t=>t.stop());
  $("camSelect").hidden=$("controls").hidden=true;ui();$("key").value="";};
$("start").onclick=()=>{if(!S.track||!S.key)return;S.running=true;capture();ui();}
$("stop").onclick=()=>{S.running=false;plan();ui();};
document.addEventListener("keydown",e=>{
  if(e.altKey&&e.key==="a"){S.running?$("stop").click():$("start").click();}
});

/* init */
if(S.key){$("key").value="********";populateCams().then(startCam);}
ui();
})();
</script>
</body>
</html>