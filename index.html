<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Traveler Vision · Math</title>
<style>
:root{--bg:#111;--fg:#fff;--accent:#5a7aff;--trk:#444}
@media(prefers-color-scheme:light){:root{--bg:#fff;--fg:#111;--accent:#4f6bff;--trk:#ddd}}
*{box-sizing:border-box;margin:0;padding:0;font:400 16px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
body{display:flex;flex-direction:column;height:100vh;background:var(--bg);color:var(--fg)}
header{padding:1rem;font-weight:600;text-align:center;border-bottom:1px solid var(--trk)}
.top{padding:1rem;display:flex;flex-direction:column;gap:1rem;position:sticky;top:0;background:var(--bg);z-index:2}
input,select,button{padding:.95rem;border-radius:8px;border:1px solid var(--trk);background:var(--bg);color:var(--fg);font:inherit}
button{background:var(--accent);color:#fff;border:none}
button:disabled{opacity:.55}
label{font-size:.9rem;opacity:.85}
.range{appearance:none;width:100%;height:5px;border-radius:3px;background:var(--trk)}
.range::-webkit-slider-thumb{appearance:none;width:22px;height:22px;border-radius:50%;background:var(--accent);cursor:pointer;border:none}
.preview{flex:1;display:flex;justify-content:center;align-items:center}
.frame{width:100%;aspect-ratio:3/4;background:#000;border-radius:10px;overflow:hidden}
.frame video{width:100%;height:100%;object-fit:contain}
footer{padding:1rem;display:flex;gap:1rem}
.logwrap{height:40vh;min-height:280px;border-top:2px solid var(--trk);display:flex;flex-direction:column}
#log{flex:1;background:var(--bg);color:var(--fg);border:none;outline:none;padding:1rem;font-family:ui-monospace,monospace;font-size:.9rem;resize:none;overflow:auto}
.bar{display:flex;gap:1rem;border-top:1px solid var(--trk)}
.bar button,.bar label{flex:1;text-align:center}
</style>
</head>
<body>

<header>Traveler Vision · Math</header>

<div class="top">
  <select id="cam" hidden></select>

  <div><label>Zoom <output id="zO">1</output>×</label><input id="zoom" class="range" type="range" step=".1"></div>

  <div id="fWrap" hidden><label>Focus <output id="fO">auto</output></label><input id="focus" class="range" type="range" step=".01"></div>

  <input id="key" type="password" placeholder="OpenAI key">
  <div style="display:flex;gap:1rem"><button id="save">Save</button><button id="clear" disabled>Clear</button></div>
</div>

<div class="preview"><div class="frame"><video id="view" autoplay muted playsinline></video></div></div>

<footer><button id="start" disabled>Start</button><button id="stop" disabled>Stop</button></footer>

<div class="logwrap">
  <textarea id="log" readonly></textarea>
  <div class="bar">
    <button id="copy">Copy all</button>
    <label><input id="verb" type="checkbox"> Verbose</label>
  </div>
</div>

<script>
(()=>{

const $=id=>document.getElementById(id);
const st={k:localStorage.getItem("TV_KEY")||"",s:null,t:null,run:false,timer:null,hw:1,dig:1};
const ts=()=>new Date().toLocaleTimeString();
const add=(m,o)=>{if(!$.verb.checked&&o) return; const b=$("log");b.value+=`[${ts()}] ${m}\n`; if(o) b.value+=JSON.stringify(o,null,2)+"\n"; b.scrollTop=b.scrollHeight};

const ui=()=>{["key","save"].forEach(i=>$(i).disabled=!!st.k);$("clear").disabled=!st.k;$("start").disabled=!st.t||!st.k||st.run;$("stop").disabled=!st.run};

async function listCams(){
  const dev=await navigator.mediaDevices.enumerateDevices();
  const cams=dev.filter(d=>d.kind==="videoinput");
  $("cam").innerHTML="";
  cams.forEach(c=>{const o=document.createElement("option");o.value=c.deviceId;o.textContent=c.label||"camera";$("cam").appendChild(o)});
  if(cams.length){$("cam").hidden=false;$("cam").onchange=initCam;}
}

async function initCam(){
  st.s?.getTracks().forEach(t=>t.stop());
  const id=$("cam").value||undefined;
  st.s=await navigator.mediaDevices.getUserMedia({
    video:{ ...(id?{deviceId:{exact:id}}:{facingMode:"environment"}),
            width:{ideal:1024}, panTiltZoom:true }});
  st.t=st.s.getVideoTracks()[0];
  $("view").srcObject=st.s;
  add("Lens ready",{label:st.t.label});
  initControls();
  ui();
}

function initControls(){
  const c=st.t.getCapabilities(),s=st.t.getSettings();
  st.hw=c.zoom?c.zoom.max:1;
  $("zoom").min=1;$("zoom").max=Math.max(12,st.hw);
  $("zoom").value=s.zoom||1;$("zO").textContent=$("zoom").value;
  $("zoom").oninput=e=>{
    const v=+e.target.value; $("zO").textContent=v;
    st.dig=v>st.hw? v/st.hw : 1;
    if(v<=st.hw) st.t.applyConstraints({advanced:[{zoom:v}]});
  };

  if(c.focusMode&&c.focusMode.includes("manual")&&c.focusDistance){
    $("fWrap").hidden=false;
    $("focus").min=c.focusDistance.min;$("focus").max=c.focusDistance.max;
    $("focus").value=s.focusDistance||c.focusDistance.min;$("fO").textContent=$("focus").value;
    $("focus").oninput=e=>{
      const v=+e.target.value;$("fO").textContent=v;
      st.t.applyConstraints({advanced:[{focusMode:"manual",focusDistance:v}]});
    };
  } else $("fWrap").hidden=true;
}

function schedule(){clearTimeout(st.timer); if(st.run) st.timer=setTimeout(capture,3500);}

function snap(v){
  const p=v.videoWidth<v.videoHeight,w=v.videoWidth,h=v.videoHeight,d=st.dig,
        cw=p?h/d:w/d, ch=p?w/d:h/d, can=document.createElement("canvas");
  can.width=p?h:w; can.height=p?w:h;
  const ctx=can.getContext("2d"); ctx.save();
  if(p){ctx.translate(can.width/2,can.height/2);ctx.rotate(Math.PI/2);ctx.translate(-can.height/2,-can.width/2);}
  ctx.drawImage(v,w/2-cw/2,h/2-ch/2,cw,ch,0,0,can.width,can.height); ctx.restore();
  return can.toDataURL("image/jpeg",.85);
}

async function callOpenAI(b64){
  const body={model:"o4-mini",reasoning_effort:"high",max_completion_tokens:768,
    messages:[{role:"user",content:[
      {type:"text",text:"Solve the math problem in the image. Think step by step and return ONLY the numeric answer on the last line."},
      {type:"image_url",image_url:{url:b64,detail:"high"}}]}]};
  if($.verb.checked) add("Payload",body); else add("Payload");
  let res;
  try{res=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${st.k}`},body:JSON.stringify(body)});}
  catch(e){throw Error("network "+e.message);}
  if(!res.ok){
    if(res.status===429){const wait=parseInt(res.headers.get("retry-after")||2);add("429, wait "+wait+"s");await new Promise(r=>setTimeout(r,wait*1000));return callOpenAI(b64);}
    throw Error("HTTP "+res.status);}
  const txt=await res.text(); if($.verb.checked) add("HTTP 200",txt.slice(0,200)); else add("HTTP 200");
  const content=JSON.parse(txt).choices?.[0]?.message?.content?.trim()||"",
        ans=content.split(/\n/).pop().trim();
  if(!/^\d/.test(ans)) throw Error("bad answer");
  return ans;
}

async function capture(){
  const v=$("view"); if(!v.videoWidth){schedule();return;}
  try{const ans=await callOpenAI(snap(v)); add("✓ "+ans); try{speechSynthesis.speak(new SpeechSynthesisUtterance(ans))}catch{}}
  catch(e){add("✗ "+e.message);}
  schedule();
}

/* BUTTONS */
$("save").onclick=()=>{st.k=$("key").value.trim(); if(!st.k) return;
  localStorage.setItem("TV_KEY",st.k); $("key").value="••••••••"; listCams().then(initCam); ui(); };
$("clear").onclick=()=>{localStorage.removeItem("TV_KEY"); st.k=""; $("key").value=""; st.s?.getTracks().forEach(t=>t.stop()); st.t=null; ui();}
$("start").onclick=()=>{if(st.t&&st.k){st.run=true; capture(); ui();}}
$("stop").onclick =()=>{st.run=false; schedule(); ui(); }
$("copy").onclick=async()=>{try{await navigator.clipboard.writeText($("log").value); add("Copied")}
  catch{const l=$("log"); l.select(); document.execCommand("copy"); add("Copy (fallback)") }};

/* INIT */
if(st.k){$("key").value="••••••••"; listCams().then(initCam) } ui();

})();
</script>
</body>
</html>
