<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Vision AI Pro - Smart Scanner</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
}

:root {
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
    --primary: #007AFF;
    --primary-light: #5AC8FA;
    --success: #34C759;
    --warning: #FF9500;
    --danger: #FF3B30;
    --bg: #000000;
    --surface: rgba(28, 28, 30, 0.95);
    --surface-elevated: rgba(44, 44, 46, 0.95);
    --text: #FFFFFF;
    --text-secondary: rgba(255, 255, 255, 0.6);
    --glass: rgba(255, 255, 255, 0.1);
    --glass-thick: rgba(255, 255, 255, 0.15);
    --border: rgba(255, 255, 255, 0.2);
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", sans-serif;
    position: fixed;
    -webkit-font-smoothing: antialiased;
}

/* Prevent bounce scrolling */
body {
    position: fixed;
    overflow: hidden;
    overscroll-behavior: none;
}

.app {
    width: 100%;
    height: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
}

/* Camera Container */
.camera-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 1;
}

#videoElement {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    background: #000;
}

/* Camera Loading State */
.camera-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 2;
    display: none;
}

.camera-loading.active {
    display: block;
}

.camera-spinner {
    width: 60px;
    height: 60px;
    border: 3px solid var(--glass);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Top Bar */
.top-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding-top: var(--safe-top);
    background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
    z-index: 100;
}

.top-bar-content {
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.app-logo {
    display: flex;
    align-items: center;
    gap: 8px;
}

.logo-icon {
    width: 32px;
    height: 32px;
    background: var(--primary);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.logo-text {
    font-size: 18px;
    font-weight: 600;
    letter-spacing: -0.5px;
}

.top-actions {
    display: flex;
    gap: 8px;
}

.icon-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
    cursor: pointer;
}

.icon-btn:active {
    transform: scale(0.9);
    background: var(--glass-thick);
}

/* Focus Frame */
.focus-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 260px;
    height: 260px;
    pointer-events: none;
    z-index: 50;
}

.focus-corners {
    position: absolute;
    width: 100%;
    height: 100%;
}

.corner {
    position: absolute;
    width: 40px;
    height: 40px;
    border: 3px solid var(--primary);
}

.corner.tl {
    top: 0;
    left: 0;
    border-right: none;
    border-bottom: none;
    border-top-left-radius: 12px;
}

.corner.tr {
    top: 0;
    right: 0;
    border-left: none;
    border-bottom: none;
    border-top-right-radius: 12px;
}

.corner.bl {
    bottom: 0;
    left: 0;
    border-right: none;
    border-top: none;
    border-bottom-left-radius: 12px;
}

.corner.br {
    bottom: 0;
    right: 0;
    border-left: none;
    border-top: none;
    border-bottom-right-radius: 12px;
}

.scan-line {
    position: absolute;
    top: 0;
    left: 3px;
    right: 3px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--primary), transparent);
    opacity: 0;
}

.scanning .scan-line {
    animation: scanAnimation 2s ease-in-out infinite;
}

@keyframes scanAnimation {
    0% { top: 0; opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { top: calc(100% - 2px); opacity: 0; }
}

/* Camera Controls - Always Visible */
.camera-controls {
    position: absolute;
    bottom: calc(var(--safe-bottom) + 180px);
    left: 20px;
    right: 20px;
    z-index: 90;
    display: flex;
    gap: 12px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.camera-controls.visible {
    opacity: 1;
}

.control-pill {
    background: var(--surface);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-height: 48px;
}

.control-label {
    font-size: 12px;
    color: var(--text-secondary);
    min-width: 40px;
}

.control-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--primary);
    min-width: 35px;
    text-align: center;
}

.control-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 4px;
    background: var(--glass);
    border-radius: 2px;
    outline: none;
}

.control-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
}

/* Bottom Section */
.bottom-section {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding-bottom: var(--safe-bottom);
    background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
    z-index: 100;
}

/* Status Display */
.status-display {
    padding: 0 20px 20px;
    text-align: center;
}

.status-text {
    font-size: 17px;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 4px;
    min-height: 24px;
}

.status-subtext {
    font-size: 14px;
    color: var(--text-secondary);
    min-height: 20px;
}

/* Main Controls */
.main-controls {
    padding: 0 20px 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
}

.scan-button {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: var(--primary);
    border: 4px solid white;
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0, 122, 255, 0.4);
    cursor: pointer;
}

.scan-button:active:not(:disabled) {
    transform: scale(0.95);
}

.scan-button:disabled {
    opacity: 0.5;
}

.scan-button.scanning {
    background: var(--danger);
    box-shadow: 0 4px 20px rgba(255, 59, 48, 0.6);
}

.scan-button.scanning::after {
    content: '';
    position: absolute;
    top: -8px;
    left: -8px;
    right: -8px;
    bottom: -8px;
    border: 2px solid var(--danger);
    border-radius: 50%;
    animation: pulse-ring 1.5s ease-out infinite;
}

@keyframes pulse-ring {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(1.3);
        opacity: 0;
    }
}

.side-button {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--surface);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.2s ease;
}

.side-button:active {
    transform: scale(0.9);
    background: var(--glass-thick);
}

/* Results Display */
.results-display {
    position: absolute;
    bottom: calc(var(--safe-bottom) + 220px);
    left: 20px;
    right: 20px;
    background: var(--surface-elevated);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    transform: translateY(300%);
    transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    z-index: 95;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

.results-display.active {
    transform: translateY(0);
}

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.result-label {
    font-size: 14px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.result-close {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--glass);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.result-answer {
    font-size: 36px;
    font-weight: 700;
    color: var(--success);
    text-align: center;
    margin-bottom: 12px;
    letter-spacing: 2px;
}

.result-explanation {
    font-size: 15px;
    color: var(--text);
    text-align: center;
    line-height: 1.5;
}

/* Settings Panel - Slide Up */
.settings-panel {
    position: fixed;
    top: 100%;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    z-index: 300;
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: flex;
    flex-direction: column;
}

.settings-panel.active {
    transform: translateY(-100%);
}

.panel-header {
    padding: 20px;
    padding-top: calc(var(--safe-top) + 20px);
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.panel-title {
    font-size: 28px;
    font-weight: 700;
}

.panel-close {
    width: 36px;
    height: 36px;
    border-radius: 18px;
    background: var(--glass);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.panel-content {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 20px;
    padding-bottom: calc(var(--safe-bottom) + 20px);
}

.settings-section {
    margin-bottom: 32px;
}

.section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
}

.input-group {
    background: var(--surface);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 12px;
}

.input-row {
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.input-row + .input-row {
    border-top: 1px solid var(--border);
}

.input-field {
    flex: 1;
    background: none;
    border: none;
    color: var(--text);
    font-size: 16px;
    font-family: monospace;
    outline: none;
}

.input-button {
    padding: 8px 16px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    white-space: nowrap;
}

.key-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: var(--glass);
    border-radius: 8px;
    font-size: 14px;
}

.key-status.valid {
    background: rgba(52, 199, 89, 0.15);
    color: var(--success);
}

/* Toggle Switch */
.toggle-row {
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.toggle-label {
    font-size: 16px;
}

.toggle-switch {
    position: relative;
    width: 51px;
    height: 31px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--glass-thick);
    border-radius: 31px;
    transition: 0.3s;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 27px;
    width: 27px;
    left: 2px;
    bottom: 2px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
}

input:checked + .toggle-slider {
    background: var(--success);
}

input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

/* History Panel */
.history-panel {
    position: fixed;
    left: 100%;
    top: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    background: var(--bg);
    z-index: 300;
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: flex;
    flex-direction: column;
}

.history-panel.active {
    transform: translateX(-100%);
}

.history-list {
    padding: 20px;
    padding-bottom: calc(var(--safe-bottom) + 20px);
}

.history-item {
    background: var(--surface);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--border);
}

.history-time {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.history-answer {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.history-question {
    font-size: 14px;
    color: var(--text);
    line-height: 1.4;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.3;
}

.empty-text {
    font-size: 16px;
    color: var(--text-secondary);
}

/* Processing Overlay */
.processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 400;
}

.processing-overlay.active {
    opacity: 1;
    visibility: visible;
}

.processing-content {
    text-align: center;
    padding: 40px;
}

.processing-animation {
    width: 80px;
    height: 80px;
    margin: 0 auto 30px;
    position: relative;
}

.processing-animation .ring {
    position: absolute;
    width: 100%;
    height: 100%;
    border: 3px solid transparent;
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.processing-animation .ring:nth-child(2) {
    width: 60px;
    height: 60px;
    top: 10px;
    left: 10px;
    border-top-color: var(--primary-light);
    animation-duration: 0.8s;
    animation-direction: reverse;
}

.processing-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
}

.processing-subtitle {
    font-size: 16px;
    color: var(--text-secondary);
}

/* Toast Notifications */
.toast {
    position: fixed;
    top: calc(var(--safe-top) + 70px);
    left: 50%;
    transform: translateX(-50%) translateY(-20px) scale(0.9);
    background: var(--surface-elevated);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 1px solid var(--border);
    padding: 16px 24px;
    border-radius: 30px;
    font-size: 15px;
    font-weight: 500;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    z-index: 500;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    max-width: calc(100% - 40px);
    text-align: center;
}

.toast.show {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0) scale(1);
}

.toast.success {
    background: var(--success);
    color: white;
    border-color: var(--success);
}

.toast.error {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
}

/* Loading States */
.shimmer {
    background: linear-gradient(90deg, var(--glass) 25%, var(--glass-thick) 50%, var(--glass) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
}

@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Touch feedback */
button:active, .icon-btn:active, .scan-button:active {
    transform: scale(0.95);
}

/* Utilities */
.hidden {
    display: none !important;
}

/* iOS Specific Fixes */
@supports (-webkit-touch-callout: none) {
    input[type="text"], input[type="password"] {
        font-size: 16px !important;
    }
    
    .app {
        height: 100vh;
        height: -webkit-fill-available;
    }
}

/* Safe area adjustments */
@supports (padding-top: env(safe-area-inset-top)) {
    .top-bar {
        padding-top: env(safe-area-inset-top);
    }
    
    .bottom-section {
        padding-bottom: env(safe-area-inset-bottom);
    }
}
</style>
</head>
<body>
<div class="app">
    <!-- Camera View -->
    <div class="camera-container">
        <video id="videoElement" playsinline autoplay muted></video>
        <div class="camera-loading" id="cameraLoading">
            <div class="camera-spinner"></div>
            <div style="color: var(--text-secondary);">Initializing camera...</div>
        </div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-content">
            <div class="app-logo">
                <div class="logo-icon">📸</div>
                <div class="logo-text">Vision AI</div>
            </div>
            <div class="top-actions">
                <button class="icon-btn" id="flashBtn" style="display: none;">🔦</button>
                <button class="icon-btn" id="settingsBtn">⚙️</button>
            </div>
        </div>
    </div>

    <!-- Focus Frame -->
    <div class="focus-frame" id="focusFrame">
        <div class="focus-corners">
            <div class="corner tl"></div>
            <div class="corner tr"></div>
            <div class="corner bl"></div>
            <div class="corner br"></div>
            <div class="scan-line"></div>
        </div>
    </div>

    <!-- Camera Controls (Zoom & Focus) -->
    <div class="camera-controls" id="cameraControls">
        <div class="control-pill" id="zoomControl" style="display: none;">
            <span class="control-label">Zoom</span>
            <span class="control-value" id="zoomValue">1.0×</span>
            <input type="range" class="control-slider" id="zoomSlider" min="1" max="5" step="0.1" value="1">
        </div>
        <div class="control-pill" id="focusControl" style="display: none;">
            <span class="control-label">Focus</span>
            <span class="control-value" id="focusValue">Auto</span>
            <input type="range" class="control-slider" id="focusSlider" min="0" max="1" step="0.01" value="0">
        </div>
    </div>

    <!-- Results Display -->
    <div class="results-display" id="resultsDisplay">
        <div class="result-header">
            <span class="result-label">Answer Found</span>
            <button class="result-close" id="closeResult">✕</button>
        </div>
        <div class="result-answer" id="resultAnswer">—</div>
        <div class="result-explanation" id="resultExplanation">—</div>
    </div>

    <!-- Bottom Section -->
    <div class="bottom-section">
        <div class="status-display">
            <div class="status-text" id="statusText">Getting ready...</div>
            <div class="status-subtext" id="statusSubtext"></div>
        </div>
        
        <div class="main-controls">
            <button class="side-button" id="historyBtn">📋</button>
            <button class="scan-button" id="scanButton" disabled></button>
            <button class="side-button" id="focusBtn">🎯</button>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="panel-header">
            <h1 class="panel-title">Settings</h1>
            <button class="panel-close" id="closeSettings">✕</button>
        </div>
        <div class="panel-content">
            <div class="settings-section">
                <h2 class="section-title">API Keys</h2>
                
                <div class="input-group">
                    <div class="input-row">
                        <input type="password" class="input-field" id="openaiKey" placeholder="OpenAI API Key (sk-...)" autocomplete="off">
                        <button class="input-button" id="saveOpenAI">Save</button>
                    </div>
                </div>
                <div class="key-status hidden" id="openaiStatus">
                    <span>✓</span>
                    <span id="openaiStatusText">Key saved</span>
                </div>
                
                <div class="input-group" style="margin-top: 12px;">
                    <div class="input-row">
                        <input type="password" class="input-field" id="geminiKey" placeholder="Google AI API Key" autocomplete="off">
                        <button class="input-button" id="saveGemini">Save</button>
                    </div>
                </div>
                <div class="key-status hidden" id="geminiStatus">
                    <span>✓</span>
                    <span id="geminiStatusText">Key saved</span>
                </div>
            </div>

            <div class="settings-section">
                <h2 class="section-title">Preferences</h2>
                <div class="input-group">
                    <div class="toggle-row">
                        <span class="toggle-label">Continuous Scanning</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="continuousMode" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Sound Effects</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundEffects" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Voice Announcement</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="voiceAnnounce" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Haptic Feedback</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="hapticFeedback" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2 class="section-title">About</h2>
                <div class="input-group">
                    <div class="toggle-row">
                        <span class="toggle-label">Version</span>
                        <span style="color: var(--text-secondary);">2.0.0</span>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Camera Status</span>
                        <span id="cameraStatusText" style="color: var(--text-secondary);">—</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="panel-header">
            <h1 class="panel-title">History</h1>
            <button class="panel-close" id="closeHistory">✕</button>
        </div>
        <div class="panel-content">
            <div class="history-list" id="historyList">
                <div class="empty-state">
                    <div class="empty-icon">📋</div>
                    <div class="empty-text">No scan history yet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
            <div class="processing-animation">
                <div class="ring"></div>
                <div class="ring"></div>
            </div>
            <div class="processing-title" id="processingTitle">Scanning...</div>
            <div class="processing-subtitle" id="processingSubtitle">Hold steady</div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>
</div>

<script>
// Vision AI Pro - Complete Implementation
const $ = id => document.getElementById(id);

// App State Management
const AppState = {
    // API Keys
    openAIKey: '',
    geminiKey: '',
    
    // Camera
    stream: null,
    videoTrack: null,
    capabilities: {},
    currentZoom: 1,
    currentFocus: 0,
    isFlashOn: false,
    
    // Processing
    isScanning: false,
    scanInterval: null,
    consecutiveErrors: 0,
    
    // UI State
    isCameraReady: false,
    areControlsVisible: false,
    
    // History
    scanHistory: [],
    
    // Settings
    continuousMode: true,
    soundEffects: true,
    voiceAnnounce: true,
    hapticFeedback: true,
    
    // Audio
    audioContext: null,
    sounds: {}
};

// Initialize Audio System
async function initAudio() {
    if (!AppState.soundEffects || typeof Tone === 'undefined') return;
    
    try {
        await Tone.start();
        AppState.audioContext = Tone.context;
        
        // Create sounds
        AppState.sounds.capture = new Tone.MembraneSynth({
            pitchDecay: 0.01,
            octaves: 2,
            envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.05 }
        }).toDestination();
        
        AppState.sounds.success = new Tone.PolySynth(Tone.Synth, {
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.1 }
        }).toDestination();
        
        AppState.sounds.error = new Tone.FMSynth({
            harmonicity: 3,
            envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }
        }).toDestination();
        
        AppState.sounds.focus = new Tone.Synth({
            oscillator: { type: 'sine' },
            envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
        }).toDestination();
        
    } catch (e) {
        console.error('Audio initialization failed:', e);
    }
}

// Play Sound Effect
function playSound(type) {
    if (!AppState.soundEffects || !AppState.sounds[type]) return;
    
    try {
        const now = Tone.now();
        switch(type) {
            case 'capture':
                AppState.sounds.capture.triggerAttack('C2', now);
                break;
            case 'success':
                AppState.sounds.success.triggerAttackRelease(['C5', 'E5', 'G5'], '8n', now);
                break;
            case 'error':
                AppState.sounds.error.triggerAttackRelease('C3', '8n', now);
                break;
            case 'focus':
                AppState.sounds.focus.triggerAttackRelease('G5', '32n', now);
                break;
        }
    } catch (e) {
        console.error('Sound playback error:', e);
    }
}

// Haptic Feedback
function haptic(type = 'light') {
    if (!AppState.hapticFeedback || !navigator.vibrate) return;
    
    switch(type) {
        case 'light':
            navigator.vibrate(10);
            break;
        case 'medium':
            navigator.vibrate(20);
            break;
        case 'heavy':
            navigator.vibrate(30);
            break;
        case 'success':
            navigator.vibrate([20, 100, 20]);
            break;
        case 'error':
            navigator.vibrate([30, 50, 30, 50, 30]);
            break;
    }
}

// UI Updates
function updateStatus(main, sub = '') {
    $('statusText').textContent = main;
    $('statusSubtext').textContent = sub;
}

function showToast(message, type = 'info', duration = 3000) {
    const toast = $('toast');
    toast.textContent = message;
    toast.className = `toast show ${type}`;
    
    clearTimeout(toast.hideTimeout);
    toast.hideTimeout = setTimeout(() => {
        toast.classList.remove('show');
    }, duration);
}

// Camera Management
async function initCamera() {
    try {
        $('cameraLoading').classList.add('active');
        updateStatus('Initializing camera...', 'Please wait');
        
        // Request permissions first
        const permissionStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } 
        });
        permissionStream.getTracks().forEach(track => track.stop());
        
        // Get optimal constraints
        const constraints = {
            video: {
                facingMode: { ideal: 'environment' },
                width: { ideal: 1920, min: 1280 },
                height: { ideal: 1080, min: 720 },
                aspectRatio: { ideal: 16/9 }
            },
            audio: false
        };
        
        AppState.stream = await navigator.mediaDevices.getUserMedia(constraints);
        AppState.videoTrack = AppState.stream.getVideoTracks()[0];
        
        // Apply to video element
        const video = $('videoElement');
        video.srcObject = AppState.stream;
        
        // Wait for video to be ready
        await new Promise((resolve, reject) => {
            video.onloadedmetadata = () => {
                video.play().then(resolve).catch(reject);
            };
            video.onerror = reject;
            setTimeout(() => reject(new Error('Video load timeout')), 5000);
        });
        
        // Setup camera capabilities
        await setupCameraCapabilities();
        
        AppState.isCameraReady = true;
        $('cameraLoading').classList.remove('active');
        $('cameraStatusText').textContent = 'Active';
        
        updateStatus('Ready to scan', 'Point at question and tap scan');
        checkReadyState();
        
    } catch (error) {
        console.error('Camera initialization failed:', error);
        $('cameraLoading').classList.remove('active');
        $('cameraStatusText').textContent = 'Failed';
        
        let errorMessage = 'Camera access denied';
        if (error.name === 'NotAllowedError') {
            errorMessage = 'Please allow camera access in settings';
        } else if (error.name === 'NotFoundError') {
            errorMessage = 'No camera found on device';
        } else if (error.message.includes('timeout')) {
            errorMessage = 'Camera initialization timed out';
        }
        
        updateStatus('Camera error', errorMessage);
        showToast(errorMessage, 'error', 5000);
    }
}

// Setup Camera Capabilities
async function setupCameraCapabilities() {
    if (!AppState.videoTrack) return;
    
    const capabilities = AppState.videoTrack.getCapabilities();
    const settings = AppState.videoTrack.getSettings();
    AppState.capabilities = capabilities;
    
    // Setup zoom control
    if (capabilities.zoom) {
        const zoomControl = $('zoomControl');
        const zoomSlider = $('zoomSlider');
        
        zoomSlider.min = capabilities.zoom.min || 1;
        zoomSlider.max = capabilities.zoom.max || 1;
        zoomSlider.value = settings.zoom || 1;
        AppState.currentZoom = settings.zoom || 1;
        
        updateZoomDisplay();
        zoomControl.style.display = 'flex';
    }
    
    // Setup focus control
    if (capabilities.focusMode && capabilities.focusMode.includes('manual')) {
        const focusControl = $('focusControl');
        const focusSlider = $('focusSlider');
        
        if (capabilities.focusDistance) {
            focusSlider.min = capabilities.focusDistance.min || 0;
            focusSlider.max = capabilities.focusDistance.max || 1;
            focusSlider.value = settings.focusDistance || 0;
            AppState.currentFocus = settings.focusDistance || 0;
        }
        
        focusControl.style.display = 'flex';
    }
    
    // Setup flash/torch
    if (capabilities.torch) {
        $('flashBtn').style.display = 'flex';
    }
    
    // Make controls visible if available
    if (capabilities.zoom || (capabilities.focusMode && capabilities.focusMode.includes('manual'))) {
        setTimeout(() => {
            $('cameraControls').classList.add('visible');
            AppState.areControlsVisible = true;
        }, 500);
    }
}

// Camera Control Functions
async function setZoom(value) {
    if (!AppState.videoTrack || !AppState.capabilities.zoom) return;
    
    try {
        await AppState.videoTrack.applyConstraints({
            advanced: [{ zoom: value }]
        });
        AppState.currentZoom = value;
        updateZoomDisplay();
        playSound('focus');
        haptic('light');
    } catch (error) {
        console.error('Zoom adjustment failed:', error);
    }
}

async function setFocus(value) {
    if (!AppState.videoTrack || !AppState.capabilities.focusMode) return;
    
    try {
        if (value === 0) {
            // Auto focus
            await AppState.videoTrack.applyConstraints({
                advanced: [{ focusMode: 'continuous' }]
            });
            $('focusValue').textContent = 'Auto';
        } else {
            // Manual focus
            await AppState.videoTrack.applyConstraints({
                advanced: [{ 
                    focusMode: 'manual',
                    focusDistance: value 
                }]
            });
            $('focusValue').textContent = Math.round(value * 100) + '%';
        }
        AppState.currentFocus = value;
        playSound('focus');
        haptic('light');
    } catch (error) {
        console.error('Focus adjustment failed:', error);
    }
}

async function toggleFlash() {
    if (!AppState.videoTrack || !AppState.capabilities.torch) return;
    
    try {
        AppState.isFlashOn = !AppState.isFlashOn;
        await AppState.videoTrack.applyConstraints({
            advanced: [{ torch: AppState.isFlashOn }]
        });
        
        $('flashBtn').style.background = AppState.isFlashOn ? 'var(--warning)' : 'var(--glass)';
        haptic('medium');
    } catch (error) {
        console.error('Flash toggle failed:', error);
    }
}

function updateZoomDisplay() {
    const zoomValue = AppState.currentZoom.toFixed(1);
    $('zoomValue').textContent = `${zoomValue}×`;
}

// Focus Lock Feature
function toggleFocusLock() {
    if (!AppState.isCameraReady) return;
    
    haptic('medium');
    $('focusFrame').classList.toggle('scanning');
    
    if ($('focusFrame').classList.contains('scanning')) {
        showToast('Focus locked', 'success', 2000);
    }
}

// Image Capture
function captureImage() {
    const video = $('videoElement');
    const canvas = document.createElement('canvas');
    
    // Use full video resolution
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    // Visual feedback
    playSound('capture');
    haptic('medium');
    
    // Flash effect
    const flash = document.createElement('div');
    flash.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        opacity: 0.8;
        z-index: 9999;
        pointer-events: none;
    `;
    document.body.appendChild(flash);
    
    setTimeout(() => flash.remove(), 100);
    
    return canvas.toDataURL('image/jpeg', 0.92);
}

// Processing Functions
function showProcessing(title, subtitle) {
    $('processingOverlay').classList.add('active');
    $('processingTitle').textContent = title;
    $('processingSubtitle').textContent = subtitle;
}

function hideProcessing() {
    $('processingOverlay').classList.remove('active');
}

// AI Processing
async function extractQuestion(imageData) {
    const messages = [
        {
            role: 'system',
            content: `You are an expert at extracting questions from images. Rules:
1. Find the MAIN question in the center/focus area of the image
2. Ignore partial text, background content, or edge text
3. Extract the COMPLETE question with ALL answer options
4. Format multiple choice clearly with each option on a new line
5. If no clear question is found, respond with "NO_QUESTION"
6. Be extremely accurate - every character matters`
        },
        {
            role: 'user',
            content: [
                { type: 'text', text: 'Extract the main question and all answer options from this image.' },
                { type: 'image_url', image_url: { url: imageData, detail: 'high' } }
            ]
        }
    ];
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AppState.openAIKey}`
        },
        body: JSON.stringify({
            model: 'gpt-4o',
            messages: messages,
            max_tokens: 800,
            temperature: 0
        })
    });
    
    if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error?.message || `API Error: ${response.status}`);
    }
    
    const data = await response.json();
    const text = data.choices[0].message.content.trim();
    
    if (text === 'NO_QUESTION') {
        throw new Error('No clear question found in image');
    }
    
    return text;
}

async function solveWithGemini(question) {
    const prompt = `You are an expert problem solver. Analyze this question carefully and provide:

1. The CORRECT ANSWER (if multiple choice, just the letter: A, B, C, or D)
2. A BRIEF explanation (maximum 2 sentences)

Question:
${question}

Important: 
- Be confident and precise
- For multiple choice, respond with ONLY the letter
- Double-check your answer before responding

Format your response as:
ANSWER: [single letter or short answer]
EXPLANATION: [brief 1-2 sentence explanation]`;
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${AppState.geminiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{
                parts: [{ text: prompt }]
            }],
            generationConfig: {
                temperature: 0.1,
                maxOutputTokens: 300,
                candidateCount: 1
            }
        })
    });
    
    if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error?.message || `API Error: ${response.status}`);
    }
    
    const data = await response.json();
    const text = data.candidates[0].content.parts[0].text;
    
    // Parse response
    const lines = text.split('\n');
    let answer = '';
    let explanation = '';
    
    for (const line of lines) {
        if (line.toUpperCase().startsWith('ANSWER:')) {
            answer = line.substring(7).trim();
        } else if (line.toUpperCase().startsWith('EXPLANATION:')) {
            explanation = line.substring(12).trim();
        }
    }
    
    if (!answer) {
        throw new Error('Failed to extract answer from AI response');
    }
    
    return { answer, explanation };
}

// Main Scanning Process
async function performScan() {
    if (!AppState.isCameraReady) {
        showToast('Camera not ready', 'error');
        return;
    }
    
    try {
        // Reset error counter on new scan
        AppState.consecutiveErrors = 0;
        
        // Step 1: Capture
        showProcessing('Capturing image...', 'Hold still');
        await new Promise(resolve => setTimeout(resolve, 300)); // Brief pause for UI
        
        const imageData = captureImage();
        
        // Step 2: Extract Question
        showProcessing('Reading question...', 'AI analyzing text');
        const question = await extractQuestion(imageData);
        
        // Step 3: Solve
        showProcessing('Solving problem...', 'Getting answer');
        const solution = await solveWithGemini(question);
        
        // Success!
        hideProcessing();
        playSound('success');
        haptic('success');
        
        // Show result
        displayResult(solution.answer, solution.explanation);
        
        // Save to history
        const historyItem = {
            id: Date.now(),
            timestamp: new Date(),
            question: question.substring(0, 150) + (question.length > 150 ? '...' : ''),
            answer: solution.answer,
            explanation: solution.explanation
        };
        
        AppState.scanHistory.unshift(historyItem);
        if (AppState.scanHistory.length > 50) {
            AppState.scanHistory = AppState.scanHistory.slice(0, 50);
        }
        saveHistory();
        updateHistoryDisplay();
        
        // Voice announcement
        if (AppState.voiceAnnounce && 'speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(`The answer is ${solution.answer}`);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            speechSynthesis.speak(utterance);
        }
        
        // Continue scanning if enabled
        if (AppState.continuousMode && AppState.isScanning) {
            AppState.scanInterval = setTimeout(() => {
                if (AppState.isScanning) {
                    performScan();
                }
            }, 5000);
        } else {
            stopScanning();
        }
        
    } catch (error) {
        console.error('Scan error:', error);
        hideProcessing();
        
        AppState.consecutiveErrors++;
        
        if (AppState.consecutiveErrors < 3 && AppState.isScanning) {
            // Auto retry
            showToast(`Retrying... (${AppState.consecutiveErrors}/3)`, 'error', 2000);
            setTimeout(() => {
                if (AppState.isScanning) {
                    performScan();
                }
            }, 2000);
        } else {
            // Give up after 3 attempts
            playSound('error');
            haptic('error');
            
            let errorMessage = 'Failed to process image';
            if (error.message.includes('NO_QUESTION') || error.message.includes('No clear question')) {
                errorMessage = 'No question found - try again';
            } else if (error.message.includes('401')) {
                errorMessage = 'Invalid API key';
            } else if (error.message.includes('network')) {
                errorMessage = 'Network error - check connection';
            }
            
            updateStatus('Scan failed', errorMessage);
            showToast(errorMessage, 'error', 4000);
            stopScanning();
        }
    }
}

// Display Result
function displayResult(answer, explanation) {
    $('resultAnswer').textContent = answer;
    $('resultExplanation').textContent = explanation || 'Answer confirmed';
    $('resultsDisplay').classList.add('active');
    
    updateStatus(`Answer: ${answer}`, 'Scan complete');
    
    // Auto-hide after 10 seconds
    clearTimeout(AppState.resultTimeout);
    AppState.resultTimeout = setTimeout(() => {
        $('resultsDisplay').classList.remove('active');
    }, 10000);
}

// Scanning Control
function startScanning() {
    if (!AppState.openAIKey || !AppState.geminiKey) {
        showToast('Please add API keys in settings', 'error');
        $('settingsPanel').classList.add('active');
        return;
    }
    
    if (!AppState.isCameraReady) {
        showToast('Camera not ready', 'error');
        return;
    }
    
    AppState.isScanning = true;
    $('scanButton').classList.add('scanning');
    $('focusFrame').classList.add('scanning');
    updateStatus('Scanning...', 'Keep question in frame');
    
    // Start scanning immediately
    performScan();
}

function stopScanning() {
    AppState.isScanning = false;
    clearTimeout(AppState.scanInterval);
    $('scanButton').classList.remove('scanning');
    $('focusFrame').classList.remove('scanning');
    updateStatus('Ready to scan', 'Tap button to start');
}

// Settings Management
function saveOpenAIKey() {
    const key = $('openaiKey').value.trim();
    if (!key.startsWith('sk-')) {
        showToast('Invalid OpenAI key format', 'error');
        return;
    }
    
    AppState.openAIKey = key;
    localStorage.setItem('visionai_openai_key', key);
    
    $('openaiStatus').classList.remove('hidden');
    $('openaiStatus').classList.add('valid');
    $('openaiStatusText').textContent = `${key.slice(0, 7)}...${key.slice(-4)}`;
    $('openaiKey').value = '';
    
    showToast('OpenAI key saved', 'success');
    haptic('success');
    checkReadyState();
}

function saveGeminiKey() {
    const key = $('geminiKey').value.trim();
    if (!key) {
        showToast('Please enter Google AI key', 'error');
        return;
    }
    
    AppState.geminiKey = key;
    localStorage.setItem('visionai_gemini_key', key);
    
    $('geminiStatus').classList.remove('hidden');
    $('geminiStatus').classList.add('valid');
    $('geminiStatusText').textContent = `${key.slice(0, 7)}...${key.slice(-4)}`;
    $('geminiKey').value = '';
    
    showToast('Google AI key saved', 'success');
    haptic('success');
    checkReadyState();
}

function checkReadyState() {
    const ready = AppState.openAIKey && AppState.geminiKey && AppState.isCameraReady;
    $('scanButton').disabled = !ready;
    
    if (!AppState.openAIKey || !AppState.geminiKey) {
        updateStatus('Setup required', 'Add API keys in settings');
    } else if (!AppState.isCameraReady) {
        updateStatus('Setting up camera...', '');
    } else {
        updateStatus('Ready to scan', 'Point at question and tap scan');
    }
}

// History Management
function saveHistory() {
    try {
        localStorage.setItem('visionai_history', JSON.stringify(AppState.scanHistory));
    } catch (e) {
        console.error('Failed to save history:', e);
    }
}

function loadHistory() {
    try {
        const saved = localStorage.getItem('visionai_history');
        if (saved) {
            AppState.scanHistory = JSON.parse(saved);
            updateHistoryDisplay();
        }
    } catch (e) {
        console.error('Failed to load history:', e);
    }
}

function updateHistoryDisplay() {
    const container = $('historyList');
    
    if (AppState.scanHistory.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">📋</div>
                <div class="empty-text">No scan history yet</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = AppState.scanHistory.map(item => {
        const time = new Date(item.timestamp);
        const timeStr = time.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
        
        return `
            <div class="history-item">
                <div class="history-time">${timeStr}</div>
                <div class="history-answer">${item.answer}</div>
                <div class="history-question">${item.question}</div>
            </div>
        `;
    }).join('');
}

// Load Settings
function loadSettings() {
    try {
        // API Keys
        AppState.openAIKey = localStorage.getItem('visionai_openai_key') || '';
        AppState.geminiKey = localStorage.getItem('visionai_gemini_key') || '';
        
        if (AppState.openAIKey) {
            $('openaiStatus').classList.remove('hidden');
            $('openaiStatus').classList.add('valid');
            $('openaiStatusText').textContent = `${AppState.openAIKey.slice(0, 7)}...${AppState.openAIKey.slice(-4)}`;
        }
        
        if (AppState.geminiKey) {
            $('geminiStatus').classList.remove('hidden');
            $('geminiStatus').classList.add('valid');
            $('geminiStatusText').textContent = `${AppState.geminiKey.slice(0, 7)}...${AppState.geminiKey.slice(-4)}`;
        }
        
        // Preferences
        AppState.continuousMode = localStorage.getItem('visionai_continuous') !== 'false';
        AppState.soundEffects = localStorage.getItem('visionai_sound') !== 'false';
        AppState.voiceAnnounce = localStorage.getItem('visionai_voice') !== 'false';
        AppState.hapticFeedback = localStorage.getItem('visionai_haptic') !== 'false';
        
        $('continuousMode').checked = AppState.continuousMode;
        $('soundEffects').checked = AppState.soundEffects;
        $('voiceAnnounce').checked = AppState.voiceAnnounce;
        $('hapticFeedback').checked = AppState.hapticFeedback;
        
    } catch (e) {
        console.error('Failed to load settings:', e);
    }
}

// Event Listeners
function setupEventListeners() {
    // Main controls
    $('scanButton').addEventListener('click', () => {
        haptic('light');
        if (AppState.isScanning) {
            stopScanning();
        } else {
            initAudio();
            startScanning();
        }
    });
    
    // Top bar
    $('flashBtn').addEventListener('click', toggleFlash);
    $('settingsBtn').addEventListener('click', () => {
        haptic('light');
        $('settingsPanel').classList.add('active');
    });
    
    // Camera controls
    $('zoomSlider').addEventListener('input', (e) => {
        setZoom(parseFloat(e.target.value));
    });
    
    $('focusSlider').addEventListener('input', (e) => {
        setFocus(parseFloat(e.target.value));
    });
    
    $('focusBtn').addEventListener('click', () => {
        toggleFocusLock();
    });
    
    // Bottom controls
    $('historyBtn').addEventListener('click', () => {
        haptic('light');
        $('historyPanel').classList.add('active');
    });
    
    // Results
    $('closeResult').addEventListener('click', () => {
        haptic('light');
        $('resultsDisplay').classList.remove('active');
    });
    
    // Settings
    $('closeSettings').addEventListener('click', () => {
        haptic('light');
        $('settingsPanel').classList.remove('active');
    });
    
    $('saveOpenAI').addEventListener('click', saveOpenAIKey);
    $('saveGemini').addEventListener('click', saveGeminiKey);
    
    $('openaiKey').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') saveOpenAIKey();
    });
    
    $('geminiKey').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') saveGeminiKey();
    });
    
    // Preferences
    $('continuousMode').addEventListener('change', (e) => {
        AppState.continuousMode = e.target.checked;
        localStorage.setItem('visionai_continuous', e.target.checked);
        haptic('light');
    });
    
    $('soundEffects').addEventListener('change', (e) => {
        AppState.soundEffects = e.target.checked;
        localStorage.setItem('visionai_sound', e.target.checked);
        haptic('light');
        if (e.target.checked) initAudio();
    });
    
    $('voiceAnnounce').addEventListener('change', (e) => {
        AppState.voiceAnnounce = e.target.checked;
        localStorage.setItem('visionai_voice', e.target.checked);
        haptic('light');
    });
    
    $('hapticFeedback').addEventListener('change', (e) => {
        AppState.hapticFeedback = e.target.checked;
        localStorage.setItem('visionai_haptic', e.target.checked);
        haptic('light');
    });
    
    // History
    $('closeHistory').addEventListener('click', () => {
        haptic('light');
        $('historyPanel').classList.remove('active');
    });
    
    // Prevent double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
            e.preventDefault();
        }
        lastTouchEnd = now;
    }, { passive: false });
    
    // Handle orientation changes
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            if (AppState.videoTrack) {
                setupCameraCapabilities();
            }
        }, 500);
    });
}

// App Initialization
async function initApp() {
    // Load settings and history
    loadSettings();
    loadHistory();
    
    // Setup event listeners
    setupEventListeners();
    
    // Check ready state
    checkReadyState();
    
    // Initialize camera
    await initCamera();
    
    // Show welcome message
    if (!AppState.openAIKey || !AppState.geminiKey) {
        setTimeout(() => {
            showToast('Welcome! Add API keys to get started', 'info', 5000);
        }, 1000);
    }
}

// Handle visibility changes
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // Stop scanning when app goes to background
        if (AppState.isScanning) {
            stopScanning();
        }
        // Turn off flash
        if (AppState.isFlashOn) {
            toggleFlash();
        }
    }
});

// Cleanup on unload
window.addEventListener('beforeunload', () => {
    if (AppState.stream) {
        AppState.stream.getTracks().forEach(track => track.stop());
    }
});

// Start the app
initApp();
</script>
</body>
</html>