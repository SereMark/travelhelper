<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Traveler Vision · Math</title>
<style>
:root{--bg:#111;--fg:#fff;--accent:#5a7aff;--trk:#444}
@media(prefers-color-scheme:light){:root{--bg:#fff;--fg:#111;--accent:#4f6bff;--trk:#ddd}}
*{box-sizing:border-box;margin:0;padding:0;font:400 16px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
body{display:flex;flex-direction:column;height:100vh;background:var(--bg);color:var(--fg)}
header{padding:1rem;font-weight:600;text-align:center;border-bottom:1px solid var(--trk)}
.top{padding:1rem;display:flex;flex-direction:column;gap:1rem;position:sticky;top:0;background:var(--bg);z-index:2}
input,select,button{padding:.95rem;border-radius:8px;border:1px solid var(--trk);background:var(--bg);color:var(--fg);font:inherit}
button{background:var(--accent);color:#fff;border:none}
button:disabled{opacity:.55}
label{font-size:.9rem;opacity:.85}
.range{appearance:none;width:100%;height:5px;border-radius:3px;background:var(--trk)}
.range::-webkit-slider-thumb{appearance:none;width:22px;height:22px;border-radius:50%;background:var(--accent);cursor:pointer;border:none}
.preview{flex:1;display:flex;justify-content:center;align-items:center}
.frame{width:100%;aspect-ratio:3/4;background:#000;border-radius:10px;overflow:hidden}
.frame video{width:100%;height:100%;object-fit:contain}
footer{padding:1rem;display:flex;gap:1rem}
.logwrap{height:40vh;min-height:280px;border-top:2px solid var(--trk);display:flex;flex-direction:column}
#log{flex:1;background:var(--bg);color:var(--fg);border:none;outline:none;padding:1rem;font-family:ui-monospace,monospace;font-size:.9rem;resize:none;overflow:auto}
.bar{display:flex;gap:1rem;border-top:1px solid var(--trk)}
.bar button,.bar label{flex:1;text-align:center}
</style>
</head>
<body>

<header>Traveler Vision · Math</header>

<div class="top">
  <select id="cam" hidden></select>

  <div><label>Zoom <output id="zVal">1</output>×</label><input id="zoom" class="range" type="range" step=".1"></div>

  <div id="focusWrap" hidden><label>Focus <output id="fVal">auto</output></label><input id="focus" class="range" type="range" step=".01"></div>

  <input id="key" type="password" placeholder="OpenAI key">
  <div style="display:flex;gap:1rem"><button id="save">Save</button><button id="clear" disabled>Clear</button></div>
</div>

<div class="preview"><div class="frame"><video id="view" autoplay muted playsinline></video></div></div>

<footer><button id="start" disabled>Start</button><button id="stop" disabled>Stop</button></footer>

<div class="logwrap">
  <textarea id="log" readonly></textarea>
  <div class="bar">
    <button id="copy">Copy all</button>
    <label><input id="verb" type="checkbox"> Verbose</label>
  </div>
</div>

<script>
(()=>{

const $=i=>document.getElementById(i);
const S={k:localStorage.getItem("TV_KEY")||"",stream:null,track:null,run:false,timer:null,hw:1,dig:1};
const ts=()=>new Date().toLocaleTimeString();
const log=(m,o)=>{if(!$.verb.checked&&o)return;const b=$("log");b.value+=`[${ts()}] ${m}\n`;if(o)b.value+=JSON.stringify(o,null,2)+"\n";b.scrollTop=b.scrollHeight};

const ui=()=>{["key","save"].forEach(id=>$(id).disabled=!!S.k);$("clear").disabled=!S.k;$("start").disabled=!S.track||!S.k||S.run;$("stop").disabled=!S.run};

const list=async()=>{const d=await navigator.mediaDevices.enumerateDevices(),c=d.filter(x=>x.kind==="videoinput");$("cam").innerHTML="";c.forEach(e=>{const o=document.createElement("option");o.value=e.deviceId;o.textContent=e.label||"camera";$("cam").appendChild(o)});if(c.length){$("cam").hidden=false;$("cam").onchange=cam}};

const cam=async()=>{S.stream?.getTracks().forEach(t=>t.stop());const id=$("cam").value||undefined;
S.stream=await navigator.mediaDevices.getUserMedia({video:id?{deviceId:{exact:id},width:{ideal:1024}}:{facingMode:"environment",width:{ideal:1024}}});
S.track=S.stream.getVideoTracks()[0];$("view").srcObject=S.stream;log("Lens ready",{label:S.track.label});ptz();ui()};

const ptz=()=>{const cap=S.track.getCapabilities(),set=S.track.getSettings();
S.hw=cap.zoom?cap.zoom.max:1;$("zoom").min=1;$("zoom").max=Math.max(12,S.hw);$("zoom").value=set.zoom||1;$("zVal").textContent=$("zoom").value;
$("zoom").oninput=e=>{const z=+e.target.value;$("zVal").textContent=z;S.dig=z>S.hw?z/S.hw:1;if(z<=S.hw)S.track.applyConstraints({advanced:[{zoom:z}]})};
if(cap.focusMode&&cap.focusMode.includes("manual")&&cap.focusDistance){$("focusWrap").hidden=false;$("focus").min=cap.focusDistance.min;$("focus").max=cap.focusDistance.max;$("focus").value=set.focusDistance||cap.focusDistance.min;$("fVal").textContent=$("focus").value;
$("focus").oninput=e=>{const v=+e.target.value;$("fVal").textContent=v;S.track.applyConstraints({advanced:[{focusMode:"manual",focusDistance:v}]})}}else{$("focusWrap").hidden=true}};

const plan=()=>{clearTimeout(S.timer);if(S.run)S.timer=setTimeout(capture,3500)};

const snap=v=>{const p=v.videoWidth<v.videoHeight,w=v.videoWidth,h=v.videoHeight,d=S.dig;
const cw=p?h/d:w/d,ch=p?w/d:h/d,can=document.createElement("canvas");can.width=p?h:w;can.height=p?w:h;
const ctx=can.getContext("2d");ctx.save();if(p){ctx.translate(can.width/2,can.height/2);ctx.rotate(Math.PI/2);ctx.translate(-can.height/2,-can.width/2)}
ctx.drawImage(v,w/2-cw/2,h/2-ch/2,cw,ch,0,0,can.width,can.height);ctx.restore();return can.toDataURL("image/jpeg",.85)};

const ask=async img=>{
  const body={model:"o4-mini",reasoning_effort:"high",max_completion_tokens:768,
    messages:[{role:"user",content:[
      {type:"text",text:"Solve the math problem in the image. Think step by step and return ONLY the numeric answer on the last line."},
      {type:"image_url",image_url:{url:img,detail:"high"}}]}]};
  log("Payload");if($.verb.checked)log("",body);
  const r=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S.k}`},body:JSON.stringify(body)})
               .catch(e=>{throw Error("network "+e.message)});
  const txt=await r.text();log("HTTP "+r.status);if($.verb.checked)log("",txt.slice(0,200));
  if(!r.ok){if(r.status===429){const w=parseInt(r.headers.get("retry-after")||2);log("Wait "+w+" s");await new Promise(rs=>setTimeout(rs,w*1000));return ask(img)}
    throw Error("HTTP "+r.status)}
  const out=JSON.parse(txt).choices?.[0]?.message?.content?.trim()||"",ans=out.split(/\n/).pop().trim();
  if($.verb.checked)log("Model",out.slice(0,120));
  if(!/^\d/.test(ans))throw Error("bad answer");return ans};

const capture=async()=>{const v=$("view");if(!v.videoWidth){plan();return}
try{const a=await ask(snap(v));log("✓ "+a);try{speechSynthesis.speak(new SpeechSynthesisUtterance(a))}catch{}}catch(e){log("✗ "+e.message)}plan()};

/* buttons */
$("save").onclick=()=>{S.k=$("key").value.trim();if(!S.k)return;localStorage.setItem("TV_KEY",S.k);$("key").value="••••••••";list().then(cam);ui()};
$("clear").onclick=()=>{localStorage.removeItem("TV_KEY");S.k="";$("key").value="";S.stream?.getTracks().forEach(t=>t.stop());S.track=null;ui()};
$("start").onclick=()=>{if(S.track&&S.k){S.run=true;capture();ui()}};
$("stop").onclick=()=>{S.run=false;plan();ui()};
$("copy").onclick=async()=>{try{await navigator.clipboard.writeText($("log").value);log("Copied")}catch{const t=$("log");t.select();document.execCommand("copy");log("Fallback copy")}};

/* init */
if(S.k){$("key").value="••••••••";list().then(cam)}ui();

})();
</script>
</body>
</html>
