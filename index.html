<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Vision AI - Smart Question Solver</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
}

:root {
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
    --primary: #00DC82;
    --primary-dark: #00B368;
    --danger: #FF3B30;
    --warning: #FF9500;
    --success: #34C759;
    --bg: #000000;
    --surface: rgba(30, 30, 30, 0.95);
    --surface-light: rgba(50, 50, 50, 0.95);
    --text: #FFFFFF;
    --text-secondary: rgba(255, 255, 255, 0.7);
    --glass: rgba(255, 255, 255, 0.1);
    --glass-border: rgba(255, 255, 255, 0.2);
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
    position: fixed;
}

/* Main Container */
.app {
    width: 100%;
    height: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
}

/* Camera View - Full Screen */
.camera-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
}

#videoElement {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* Top Bar - Minimal */
.top-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: calc(var(--safe-top) + 12px) 20px 12px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
    z-index: 100;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.app-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.settings-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
}

.settings-btn:active {
    transform: scale(0.9);
    background: var(--glass-border);
}

/* Scanning Overlay */
.scan-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 280px;
    height: 280px;
    pointer-events: none;
    z-index: 50;
}

.scan-frame {
    width: 100%;
    height: 100%;
    position: relative;
}

.scan-corner {
    position: absolute;
    width: 50px;
    height: 50px;
    border: 3px solid var(--primary);
    opacity: 0.8;
}

.scan-corner.tl {
    top: 0;
    left: 0;
    border-right: none;
    border-bottom: none;
}

.scan-corner.tr {
    top: 0;
    right: 0;
    border-left: none;
    border-bottom: none;
}

.scan-corner.bl {
    bottom: 0;
    left: 0;
    border-right: none;
    border-top: none;
}

.scan-corner.br {
    bottom: 0;
    right: 0;
    border-left: none;
    border-top: none;
}

.scan-line {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--primary), transparent);
    opacity: 0;
    animation: scanLine 2s ease-in-out infinite;
}

@keyframes scanLine {
    0% { top: 0; opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { top: 100%; opacity: 0; }
}

.scan-hint {
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
    white-space: nowrap;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
}

/* Bottom Controls */
.bottom-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 20px 20px calc(var(--safe-bottom) + 20px);
    background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
    z-index: 100;
}

.main-button {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    display: block;
    border-radius: 50%;
    border: 4px solid var(--text);
    background: var(--primary);
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0, 220, 130, 0.4);
}

.main-button:active {
    transform: scale(0.9);
}

.main-button.recording {
    background: var(--danger);
    box-shadow: 0 4px 20px rgba(255, 59, 48, 0.4);
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 4px 20px rgba(255, 59, 48, 0.4); }
    50% { box-shadow: 0 4px 30px rgba(255, 59, 48, 0.8); }
    100% { box-shadow: 0 4px 20px rgba(255, 59, 48, 0.4); }
}

.main-button-inner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 30px;
    height: 30px;
    background: var(--text);
    border-radius: 50%;
    transition: all 0.3s ease;
}

.main-button.recording .main-button-inner {
    border-radius: 8px;
    width: 25px;
    height: 25px;
}

.status-text {
    text-align: center;
    font-size: 16px;
    color: var(--text);
    margin-bottom: 10px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    min-height: 20px;
}

/* Results Display */
.result-card {
    position: absolute;
    bottom: calc(var(--safe-bottom) + 140px);
    left: 20px;
    right: 20px;
    background: var(--surface);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 20px;
    transform: translateY(200%);
    transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    z-index: 90;
    border: 1px solid var(--glass-border);
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.result-card.active {
    transform: translateY(0);
}

.result-answer {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    text-align: center;
    margin-bottom: 10px;
    letter-spacing: 2px;
}

.result-explanation {
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
    line-height: 1.4;
}

.result-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

/* Settings Panel */
.settings-panel {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 200;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.settings-panel.active {
    transform: translateX(0);
}

.settings-header {
    padding: calc(var(--safe-top) + 20px) 20px 20px;
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.settings-title {
    font-size: 24px;
    font-weight: 700;
}

.settings-close {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.settings-content {
    padding: 20px;
    padding-bottom: calc(var(--safe-bottom) + 20px);
}

.settings-section {
    margin-bottom: 30px;
}

.settings-label {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.api-input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.api-input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    padding: 15px;
    border-radius: 12px;
    color: var(--text);
    font-size: 16px;
    font-family: monospace;
}

.api-input:focus {
    outline: none;
    border-color: var(--primary);
}

.api-save-btn {
    padding: 15px 25px;
    background: var(--primary);
    color: var(--bg);
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
}

.api-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: var(--glass);
    border-radius: 8px;
    font-size: 14px;
    margin-bottom: 10px;
}

.api-status.valid {
    background: rgba(52, 199, 89, 0.2);
    color: var(--success);
}

.settings-option {
    background: var(--surface);
    border: 1px solid var(--glass-border);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Processing Animation */
.processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 300;
}

.processing-overlay.active {
    opacity: 1;
    visibility: visible;
}

.processing-icon {
    width: 100px;
    height: 100px;
    margin-bottom: 30px;
    position: relative;
}

.processing-ring {
    position: absolute;
    width: 100%;
    height: 100%;
    border: 3px solid var(--glass);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.processing-text {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 10px;
}

.processing-subtext {
    font-size: 16px;
    color: var(--text-secondary);
}

/* Toast Notifications */
.toast {
    position: fixed;
    top: calc(var(--safe-top) + 80px);
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: var(--surface);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    padding: 15px 25px;
    border-radius: 30px;
    font-size: 16px;
    font-weight: 500;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 400;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    max-width: 80%;
    text-align: center;
}

.toast.show {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
}

.toast.success {
    background: rgba(52, 199, 89, 0.9);
}

.toast.error {
    background: rgba(255, 59, 48, 0.9);
}

/* Quick Actions */
.quick-actions {
    position: absolute;
    bottom: calc(var(--safe-bottom) + 120px);
    left: 20px;
    display: flex;
    gap: 10px;
    z-index: 80;
}

.quick-action {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

/* History View */
.history-view {
    position: fixed;
    top: 100%;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    z-index: 250;
    transition: transform 0.3s ease;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.history-view.active {
    transform: translateY(-100%);
}

.history-header {
    position: sticky;
    top: 0;
    background: var(--bg);
    padding: calc(var(--safe-top) + 20px) 20px 20px;
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 10;
}

.history-content {
    padding: 20px;
    padding-bottom: calc(var(--safe-bottom) + 20px);
}

.history-item {
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
}

.history-time {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.history-answer {
    font-size: 20px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 8px;
}

.history-question {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.4;
}

/* Utilities */
.hidden { display: none !important; }

/* Disable pull-to-refresh */
body {
    overscroll-behavior-y: contain;
}

/* Better touch responsiveness */
button, .settings-btn, .quick-action, .main-button {
    touch-action: manipulation;
}

input {
    font-size: 16px !important; /* Prevents zoom on iOS */
}
</style>
</head>
<body>
<div class="app">
    <!-- Camera View -->
    <div class="camera-view">
        <video id="videoElement" playsinline autoplay muted></video>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="app-title">Vision AI</div>
        <button class="settings-btn" id="settingsBtn">⚙️</button>
    </div>

    <!-- Scanning Overlay -->
    <div class="scan-overlay">
        <div class="scan-frame">
            <div class="scan-corner tl"></div>
            <div class="scan-corner tr"></div>
            <div class="scan-corner bl"></div>
            <div class="scan-corner br"></div>
            <div class="scan-line"></div>
        </div>
        <div class="scan-hint" id="scanHint">Point at question</div>
    </div>

    <!-- Bottom Controls -->
    <div class="bottom-controls">
        <div class="status-text" id="statusText">Add API keys to start</div>
        <button class="main-button" id="mainButton" disabled>
            <div class="main-button-inner"></div>
        </button>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-action" id="historyBtn" title="History">📋</button>
        <button class="quick-action hidden" id="flashBtn" title="Flash">🔦</button>
    </div>

    <!-- Result Card -->
    <div class="result-card" id="resultCard">
        <button class="result-close" id="closeResult">✕</button>
        <div class="result-answer" id="resultAnswer">A</div>
        <div class="result-explanation" id="resultExplanation">The correct answer is A</div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2 class="settings-title">Settings</h2>
            <button class="settings-close" id="closeSettings">✕</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-label">OpenAI API Key</div>
                <div class="api-status hidden" id="openaiStatus">
                    <span>✓</span> <span id="openaiStatusText">Key saved</span>
                </div>
                <div class="api-input-group">
                    <input type="password" class="api-input" id="openaiKey" placeholder="sk-..." autocomplete="off">
                    <button class="api-save-btn" id="saveOpenAI">Save</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-label">Google AI API Key</div>
                <div class="api-status hidden" id="geminiStatus">
                    <span>✓</span> <span id="geminiStatusText">Key saved</span>
                </div>
                <div class="api-input-group">
                    <input type="password" class="api-input" id="geminiKey" placeholder="AI..." autocomplete="off">
                    <button class="api-save-btn" id="saveGemini">Save</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-label">Options</div>
                <div class="settings-option">
                    <span>Continuous Mode</span>
                    <input type="checkbox" id="continuousMode" checked>
                </div>
                <div class="settings-option">
                    <span>Sound Effects</span>
                    <input type="checkbox" id="soundEnabled" checked>
                </div>
                <div class="settings-option">
                    <span>Voice Announcement</span>
                    <input type="checkbox" id="voiceEnabled" checked>
                </div>
            </div>
        </div>
    </div>

    <!-- History View -->
    <div class="history-view" id="historyView">
        <div class="history-header">
            <h2 class="settings-title">History</h2>
            <button class="settings-close" id="closeHistory">✕</button>
        </div>
        <div class="history-content" id="historyContent">
            <p style="text-align: center; color: var(--text-secondary);">No results yet</p>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-icon">
            <div class="processing-ring"></div>
        </div>
        <div class="processing-text" id="processingText">Scanning...</div>
        <div class="processing-subtext" id="processingSubtext">Hold steady</div>
    </div>

    <!-- Toast Container -->
    <div class="toast" id="toast"></div>
</div>

<script>
// Mobile-optimized Vision AI App
const $ = id => document.getElementById(id);

// App State
const App = {
    // API Keys
    openAIKey: '',
    geminiKey: '',
    
    // Camera
    stream: null,
    track: null,
    facingMode: 'environment',
    
    // Processing
    isScanning: false,
    scanInterval: null,
    retryCount: 0,
    maxRetries: 3,
    
    // Results
    history: [],
    lastResult: null,
    
    // Settings
    continuousMode: true,
    soundEnabled: true,
    voiceEnabled: true,
    
    // Audio
    audioContext: null,
    sounds: {}
};

// Initialize Audio
async function initAudio() {
    if (!App.soundEnabled || typeof Tone === 'undefined') return;
    
    try {
        await Tone.start();
        
        // Camera shutter sound
        App.sounds.capture = new Tone.MembraneSynth({
            pitchDecay: 0.008,
            octaves: 2,
            envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.01 }
        }).toDestination();
        
        // Success sound
        App.sounds.success = new Tone.PolySynth(Tone.Synth, {
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 }
        }).toDestination();
        
        // Error sound
        App.sounds.error = new Tone.FMSynth({
            harmonicity: 3,
            modulationIndex: 5,
            envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }
        }).toDestination();
        
    } catch (e) {
        console.error('Audio init failed:', e);
    }
}

// Play Sound
function playSound(type) {
    if (!App.soundEnabled || !App.sounds[type]) return;
    
    const now = Tone.now();
    try {
        switch(type) {
            case 'capture':
                App.sounds.capture.triggerAttack('C2', now);
                break;
            case 'success':
                App.sounds.success.triggerAttackRelease(['C5', 'E5', 'G5'], '8n', now);
                break;
            case 'error':
                App.sounds.error.triggerAttackRelease('C3', '8n', now);
                break;
        }
    } catch (e) {
        console.error('Sound error:', e);
    }
}

// Show Toast
function showToast(message, type = 'info', duration = 3000) {
    const toast = $('toast');
    toast.textContent = message;
    toast.className = `toast show ${type}`;
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, duration);
}

// Update Status
function updateStatus(text) {
    $('statusText').textContent = text;
}

// Save API Keys
function saveOpenAIKey() {
    const key = $('openaiKey').value.trim();
    if (!key.startsWith('sk-')) {
        showToast('Invalid OpenAI key format', 'error');
        return;
    }
    
    App.openAIKey = key;
    localStorage.setItem('visionai_openai', key);
    
    $('openaiStatus').classList.remove('hidden');
    $('openaiStatus').classList.add('valid');
    $('openaiStatusText').textContent = `Key: ${key.slice(0,7)}...${key.slice(-4)}`;
    $('openaiKey').value = '';
    
    showToast('OpenAI key saved', 'success');
    checkReady();
}

function saveGeminiKey() {
    const key = $('geminiKey').value.trim();
    if (!key) {
        showToast('Please enter Google AI key', 'error');
        return;
    }
    
    App.geminiKey = key;
    localStorage.setItem('visionai_gemini', key);
    
    $('geminiStatus').classList.remove('hidden');
    $('geminiStatus').classList.add('valid');
    $('geminiStatusText').textContent = `Key: ${key.slice(0,7)}...${key.slice(-4)}`;
    $('geminiKey').value = '';
    
    showToast('Google AI key saved', 'success');
    checkReady();
}

// Check if Ready
function checkReady() {
    const ready = App.openAIKey && App.geminiKey && App.stream;
    $('mainButton').disabled = !ready;
    
    if (ready) {
        updateStatus('Ready to scan');
        $('scanHint').textContent = 'Tap button to scan';
    } else if (!App.openAIKey || !App.geminiKey) {
        updateStatus('Add API keys to start');
    } else {
        updateStatus('Setting up camera...');
    }
}

// Initialize Camera
async function initCamera() {
    try {
        const constraints = {
            video: {
                facingMode: App.facingMode,
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            audio: false
        };
        
        App.stream = await navigator.mediaDevices.getUserMedia(constraints);
        App.track = App.stream.getVideoTracks()[0];
        
        const video = $('videoElement');
        video.srcObject = App.stream;
        
        // Apply settings if supported
        const capabilities = App.track.getCapabilities();
        const settings = {};
        
        if (capabilities.focusMode?.includes('continuous')) {
            settings.focusMode = 'continuous';
        }
        
        if (capabilities.torch) {
            $('flashBtn').classList.remove('hidden');
        }
        
        if (Object.keys(settings).length > 0) {
            await App.track.applyConstraints({ advanced: [settings] });
        }
        
        updateStatus('Camera ready');
        checkReady();
        
    } catch (error) {
        console.error('Camera error:', error);
        updateStatus('Camera not available');
        showToast('Camera access denied', 'error');
    }
}

// Toggle Flash
async function toggleFlash() {
    if (!App.track) return;
    
    try {
        const settings = App.track.getSettings();
        await App.track.applyConstraints({
            advanced: [{ torch: !settings.torch }]
        });
    } catch (e) {
        console.error('Flash toggle failed:', e);
    }
}

// Capture Image
function captureImage() {
    const video = $('videoElement');
    const canvas = document.createElement('canvas');
    
    // Use full resolution
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    playSound('capture');
    
    // Flash effect
    video.style.opacity = '0';
    setTimeout(() => video.style.opacity = '1', 100);
    
    return canvas.toDataURL('image/jpeg', 0.95);
}

// Show Processing
function showProcessing(text = 'Scanning...', subtext = 'Hold steady') {
    $('processingOverlay').classList.add('active');
    $('processingText').textContent = text;
    $('processingSubtext').textContent = subtext;
}

// Hide Processing
function hideProcessing() {
    $('processingOverlay').classList.remove('active');
}

// Extract Question with OpenAI
async function extractQuestion(imageData) {
    const messages = [
        {
            role: 'system',
            content: `You are an expert at reading questions from images. Your job is to:
1. Find the MAIN question in the center of the image
2. Ignore partial questions, background text, or screen edges
3. Extract the COMPLETE question text including ALL answer options
4. If it's multiple choice, format it clearly with options on new lines
5. If no clear question is visible, respond with "NO_QUESTION"

Be extremely accurate - every word and number matters.`
        },
        {
            role: 'user',
            content: [
                { type: 'text', text: 'Extract the complete question and all answer options from this image.' },
                { type: 'image_url', image_url: { url: imageData, detail: 'high' } }
            ]
        }
    ];
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${App.openAIKey}`
        },
        body: JSON.stringify({
            model: 'gpt-4o',
            messages: messages,
            max_tokens: 500,
            temperature: 0
        })
    });
    
    if (!response.ok) {
        throw new Error(`OpenAI error: ${response.status}`);
    }
    
    const data = await response.json();
    const text = data.choices[0].message.content.trim();
    
    if (text === 'NO_QUESTION') {
        throw new Error('No question found');
    }
    
    return text;
}

// Solve with Gemini
async function solveWithGemini(question) {
    const prompt = `You are an expert problem solver. Given this question, provide:

1. The CORRECT ANSWER (just the letter/number if multiple choice)
2. A BRIEF explanation (1-2 sentences max)

Question:
${question}

Important: Be confident and accurate. For multiple choice, just give the letter (A, B, C, etc).

Format:
ANSWER: [your answer]
REASON: [brief explanation]`;
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${App.geminiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{
                parts: [{ text: prompt }]
            }],
            generationConfig: {
                temperature: 0.1,
                maxOutputTokens: 500
            }
        })
    });
    
    if (!response.ok) {
        throw new Error(`Gemini error: ${response.status}`);
    }
    
    const data = await response.json();
    const text = data.candidates[0].content.parts[0].text;
    
    // Parse response
    const lines = text.split('\n');
    let answer = '';
    let reason = '';
    
    for (const line of lines) {
        if (line.startsWith('ANSWER:')) {
            answer = line.replace('ANSWER:', '').trim();
        } else if (line.startsWith('REASON:')) {
            reason = line.replace('REASON:', '').trim();
        }
    }
    
    return { answer, reason };
}

// Process Scan with Retry Logic
async function processScan() {
    App.retryCount = 0;
    
    while (App.retryCount < App.maxRetries) {
        try {
            // Capture
            showProcessing('Capturing...', 'Hold still');
            const imageData = captureImage();
            
            // Extract
            showProcessing('Reading question...', 'AI analyzing');
            const question = await extractQuestion(imageData);
            
            // Solve
            showProcessing('Solving...', 'Getting answer');
            const solution = await solveWithGemini(question);
            
            // Success!
            hideProcessing();
            playSound('success');
            
            // Show result
            showResult(solution.answer, solution.reason);
            
            // Save to history
            const result = {
                time: new Date(),
                question: question.substring(0, 100) + '...',
                answer: solution.answer,
                reason: solution.reason
            };
            
            App.history.unshift(result);
            App.lastResult = result;
            saveHistory();
            
            // Voice announcement
            if (App.voiceEnabled && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(
                    `The answer is ${solution.answer}`
                );
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
            
            return; // Success, exit retry loop
            
        } catch (error) {
            console.error('Scan error:', error);
            App.retryCount++;
            
            if (App.retryCount >= App.maxRetries) {
                hideProcessing();
                playSound('error');
                showToast('Failed to read question. Try again.', 'error');
                updateStatus('Scan failed - try again');
            } else {
                // Retry with different message
                showProcessing('Retrying...', `Attempt ${App.retryCount + 1} of ${App.maxRetries}`);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
    }
}

// Show Result
function showResult(answer, explanation) {
    $('resultAnswer').textContent = answer;
    $('resultExplanation').textContent = explanation || 'Answer confirmed';
    $('resultCard').classList.add('active');
    
    updateStatus(`Answer: ${answer}`);
}

// Hide Result
function hideResult() {
    $('resultCard').classList.remove('active');
}

// Start/Stop Scanning
function toggleScanning() {
    if (!App.isScanning) {
        startScanning();
    } else {
        stopScanning();
    }
}

function startScanning() {
    App.isScanning = true;
    $('mainButton').classList.add('recording');
    updateStatus('Scanning active');
    $('scanHint').textContent = 'Scanning...';
    
    // Process immediately
    processScan().then(() => {
        if (App.continuousMode && App.isScanning) {
            // Continue scanning
            App.scanInterval = setInterval(() => {
                if (App.isScanning) {
                    processScan();
                }
            }, 5000);
        } else {
            stopScanning();
        }
    });
}

function stopScanning() {
    App.isScanning = false;
    clearInterval(App.scanInterval);
    $('mainButton').classList.remove('recording');
    updateStatus('Ready to scan');
    $('scanHint').textContent = 'Tap button to scan';
}

// Save/Load History
function saveHistory() {
    try {
        const historyData = App.history.slice(0, 20); // Keep last 20
        localStorage.setItem('visionai_history', JSON.stringify(historyData));
        updateHistoryView();
    } catch (e) {
        console.error('Save history error:', e);
    }
}

function loadHistory() {
    try {
        const data = localStorage.getItem('visionai_history');
        if (data) {
            App.history = JSON.parse(data);
            updateHistoryView();
        }
    } catch (e) {
        console.error('Load history error:', e);
    }
}

function updateHistoryView() {
    const content = $('historyContent');
    
    if (App.history.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No results yet</p>';
        return;
    }
    
    content.innerHTML = App.history.map(item => {
        const time = new Date(item.time).toLocaleString();
        return `
            <div class="history-item">
                <div class="history-time">${time}</div>
                <div class="history-answer">${item.answer}</div>
                <div class="history-question">${item.question}</div>
            </div>
        `;
    }).join('');
}

// Event Listeners
$('mainButton').addEventListener('click', () => {
    initAudio();
    toggleScanning();
});

$('settingsBtn').addEventListener('click', () => {
    $('settingsPanel').classList.add('active');
});

$('closeSettings').addEventListener('click', () => {
    $('settingsPanel').classList.remove('active');
});

$('historyBtn').addEventListener('click', () => {
    $('historyView').classList.add('active');
});

$('closeHistory').addEventListener('click', () => {
    $('historyView').classList.remove('active');
});

$('flashBtn').addEventListener('click', toggleFlash);

$('closeResult').addEventListener('click', hideResult);

$('saveOpenAI').addEventListener('click', saveOpenAIKey);
$('saveGemini').addEventListener('click', saveGeminiKey);

// Settings toggles
$('continuousMode').addEventListener('change', (e) => {
    App.continuousMode = e.target.checked;
    localStorage.setItem('visionai_continuous', e.target.checked);
});

$('soundEnabled').addEventListener('change', (e) => {
    App.soundEnabled = e.target.checked;
    localStorage.setItem('visionai_sound', e.target.checked);
});

$('voiceEnabled').addEventListener('change', (e) => {
    App.voiceEnabled = e.target.checked;
    localStorage.setItem('visionai_voice', e.target.checked);
});

// Prevent zoom on double tap
let lastTouchEnd = 0;
document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
        e.preventDefault();
    }
    lastTouchEnd = now;
}, false);

// Initialize App
async function init() {
    // Load saved data
    try {
        App.openAIKey = localStorage.getItem('visionai_openai') || '';
        App.geminiKey = localStorage.getItem('visionai_gemini') || '';
        App.continuousMode = localStorage.getItem('visionai_continuous') !== 'false';
        App.soundEnabled = localStorage.getItem('visionai_sound') !== 'false';
        App.voiceEnabled = localStorage.getItem('visionai_voice') !== 'false';
        
        // Update UI
        if (App.openAIKey) {
            $('openaiStatus').classList.remove('hidden');
            $('openaiStatus').classList.add('valid');
            $('openaiStatusText').textContent = `Key: ${App.openAIKey.slice(0,7)}...${App.openAIKey.slice(-4)}`;
        }
        
        if (App.geminiKey) {
            $('geminiStatus').classList.remove('hidden');
            $('geminiStatus').classList.add('valid');
            $('geminiStatusText').textContent = `Key: ${App.geminiKey.slice(0,7)}...${App.geminiKey.slice(-4)}`;
        }
        
        $('continuousMode').checked = App.continuousMode;
        $('soundEnabled').checked = App.soundEnabled;
        $('voiceEnabled').checked = App.voiceEnabled;
        
    } catch (e) {
        console.error('Load settings error:', e);
    }
    
    // Load history
    loadHistory();
    
    // Initialize camera
    await initCamera();
    
    // Check ready state
    checkReady();
}

// Start app
init();

// Handle page visibility
document.addEventListener('visibilitychange', () => {
    if (document.hidden && App.isScanning) {
        stopScanning();
    }
});

// Cleanup on unload
window.addEventListener('beforeunload', () => {
    if (App.stream) {
        App.stream.getTracks().forEach(track => track.stop());
    }
});
</script>
</body>
</html>