<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Vision AI Pro - Advanced Question Solver</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<style>
:root {
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --primary-active: #1e40af;
    --secondary: #7c3aed;
    --secondary-hover: #6d28d9;
    --success: #10b981;
    --error: #ef4444;
    --warning: #f59e0b;
    --bg: #0f172a;
    --surface: #1e293b;
    --surface-light: #334155;
    --text: #f1f5f9;
    --text-secondary: #cbd5e1;
    --border: #475569;
    --shadow: rgba(0, 0, 0, 0.5);
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    font-size: 16px;
}

@media (prefers-color-scheme: light) {
    :root {
        --bg: #f8fafc;
        --surface: #ffffff;
        --surface-light: #f1f5f9;
        --text: #0f172a;
        --text-secondary: #475569;
        --border: #e2e8f0;
        --shadow: rgba(0, 0, 0, 0.1);
    }
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

html, body {
    height: 100%;
    overflow: hidden;
    background: var(--bg);
    color: var(--text);
}

body {
    display: flex;
    flex-direction: column;
    position: relative;
}

/* Animated Background */
.animated-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    opacity: 0.05;
    background: linear-gradient(45deg, var(--primary) 25%, transparent 25%),
                linear-gradient(-45deg, var(--primary) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, var(--secondary) 75%),
                linear-gradient(-45deg, transparent 75%, var(--secondary) 75%);
    background-size: 30px 30px;
    animation: bgMove 20s linear infinite;
}

@keyframes bgMove {
    0% { background-position: 0 0, 0 0, 15px 15px, 15px 15px; }
    100% { background-position: 30px 30px, -30px -30px, 45px 45px, -15px -15px; }
}

/* Header */
header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px var(--shadow);
    z-index: 100;
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 700;
    font-size: 1.25rem;
}

.logo-icon {
    width: 32px;
    height: 32px;
    background: var(--gradient-primary);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.header-actions {
    display: flex;
    gap: 0.5rem;
}

/* Main Content */
.main-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* API Keys Section */
.api-section {
    background: var(--surface);
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.api-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.api-input-row {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.api-input-row input {
    flex: 1;
}

.api-display {
    background: var(--surface-light);
    padding: 0.75rem;
    border-radius: 8px;
    font-family: monospace;
    font-size: 0.875rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Camera Controls */
.camera-controls {
    background: var(--surface);
    padding: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    border-bottom: 1px solid var(--border);
}

.control-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
    min-width: 200px;
}

/* Preview Area */
.preview-container {
    flex: 1;
    background: #000;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.video-frame {
    position: relative;
    width: 100%;
    max-width: 600px;
    aspect-ratio: 3/4;
    background: #000;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
}

video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Process Overlay */
.process-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.process-overlay.active {
    opacity: 1;
    visibility: visible;
}

.process-content {
    text-align: center;
    color: white;
}

.process-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1rem;
    position: relative;
}

.scanner-line {
    position: absolute;
    width: 100%;
    height: 2px;
    background: var(--primary);
    box-shadow: 0 0 10px var(--primary);
    animation: scan 2s ease-in-out infinite;
}

@keyframes scan {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(78px); }
}

.process-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.process-subtitle {
    font-size: 1rem;
    color: #94a3b8;
    margin-bottom: 2rem;
}

.process-steps {
    display: flex;
    gap: 2rem;
    margin-top: 2rem;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    opacity: 0.5;
    transition: all 0.3s ease;
}

.step.active {
    opacity: 1;
}

.step-icon {
    width: 48px;
    height: 48px;
    background: var(--surface-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    position: relative;
}

.step.active .step-icon {
    background: var(--primary);
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
    100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
}

.step-label {
    font-size: 0.875rem;
}

/* Status Bar */
.status-bar {
    background: var(--surface);
    padding: 1rem;
    text-align: center;
    border-top: 1px solid var(--border);
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    min-height: 60px;
}

.status-icon {
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.status-bar.success {
    background: var(--success);
    color: white;
}

.status-bar.error {
    background: var(--error);
    color: white;
}

/* Action Buttons */
.actions {
    background: var(--surface);
    padding: 1rem;
    display: flex;
    gap: 1rem;
    border-top: 1px solid var(--border);
}

.actions button {
    flex: 1;
}

/* Results Panel */
.results-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--surface);
    border-top: 2px solid var(--primary);
    transform: translateY(100%);
    transition: transform 0.3s ease;
    max-height: 50vh;
    overflow-y: auto;
    z-index: 200;
    box-shadow: 0 -8px 32px var(--shadow);
}

.results-panel.active {
    transform: translateY(0);
}

.results-header {
    padding: 1rem;
    background: var(--surface-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
}

.results-content {
    padding: 1.5rem;
}

.result-item {
    background: var(--bg);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.result-question {
    font-size: 1rem;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
}

.result-answer {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary);
}

/* Form Elements */
input, select, textarea {
    background: var(--surface-light);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.75rem;
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

button:hover:not(:disabled) {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

button:active:not(:disabled) {
    background: var(--primary-active);
    transform: translateY(0);
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

button.secondary {
    background: var(--surface-light);
    color: var(--text);
}

button.secondary:hover:not(:disabled) {
    background: var(--border);
}

button.success {
    background: var(--success);
}

button.success:hover:not(:disabled) {
    background: #059669;
}

button.icon-button {
    padding: 0.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Range Slider */
.range-slider {
    appearance: none;
    width: 100%;
    height: 6px;
    background: var(--surface-light);
    border-radius: 3px;
    outline: none;
}

.range-slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 8px var(--shadow);
    transition: all 0.2s ease;
}

.range-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 4px 12px var(--shadow);
}

/* Labels */
label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.toast {
    background: var(--surface);
    color: var(--text);
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px var(--shadow);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 300px;
    animation: slideIn 0.3s ease;
    border-left: 4px solid var(--primary);
}

.toast.success {
    border-left-color: var(--success);
}

.toast.error {
    border-left-color: var(--error);
}

.toast.warning {
    border-left-color: var(--warning);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.toast-icon {
    font-size: 1.5rem;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.toast-message {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

/* Loading Spinner */
.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.8s ease-in-out infinite;
}

/* Responsive */
@media (max-width: 768px) {
    .camera-controls {
        flex-direction: column;
    }
    
    .control-item {
        min-width: 100%;
    }
    
    .process-steps {
        flex-direction: column;
        gap: 1rem;
    }
    
    .actions {
        flex-direction: column;
    }
}

/* Hidden */
.hidden {
    display: none !important;
}

/* Fade animations */
.fade-in {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
</head>
<body>
<div class="animated-bg"></div>

<header>
    <div class="logo">
        <div class="logo-icon">üì∏</div>
        <span>Vision AI Pro</span>
    </div>
    <div class="header-actions">
        <button class="icon-button secondary" id="historyBtn" title="View History">üìã</button>
        <button class="icon-button secondary" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
    </div>
</header>

<div class="main-container">
    <div class="api-section">
        <div class="api-group">
            <label>OpenAI API Key (for question extraction)</label>
            <div id="openaiKeyEntry" class="api-input-row">
                <input type="password" id="openaiKey" placeholder="sk-..." />
                <button id="saveOpenAIKey">Save</button>
            </div>
            <div id="openaiKeyDisplay" class="api-display hidden">
                <span id="openaiKeyText">Key: sk-‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                <button class="secondary" id="changeOpenAIKey">Change</button>
            </div>
        </div>
        
        <div class="api-group">
            <label>Google AI API Key (for solving questions)</label>
            <div id="geminiKeyEntry" class="api-input-row">
                <input type="password" id="geminiKey" placeholder="AI..." />
                <button id="saveGeminiKey">Save</button>
            </div>
            <div id="geminiKeyDisplay" class="api-display hidden">
                <span id="geminiKeyText">Key: AI‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                <button class="secondary" id="changeGeminiKey">Change</button>
            </div>
        </div>
    </div>

    <div class="camera-controls hidden" id="cameraControls">
        <div class="control-item">
            <label>Camera</label>
            <select id="cameraSelect">
                <option>Loading cameras...</option>
            </select>
        </div>
        
        <div class="control-item" id="zoomControl">
            <label>Zoom: <span id="zoomValue">1.0x</span></label>
            <input type="range" class="range-slider" id="zoomSlider" min="1" max="10" step="0.1" value="1" />
        </div>
        
        <div class="control-item">
            <label>Quality</label>
            <select id="qualitySelect">
                <option value="high" selected>High Quality</option>
                <option value="medium">Medium Quality</option>
                <option value="low">Low Quality</option>
            </select>
        </div>
    </div>

    <div class="preview-container">
        <div class="video-frame">
            <video id="videoPreview" autoplay muted playsinline></video>
            <div class="process-overlay" id="processOverlay">
                <div class="process-content">
                    <div class="process-icon">
                        <div class="scanner-line"></div>
                        <svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="10" y="10" width="20" height="20" />
                            <rect x="70" y="10" width="20" height="20" />
                            <rect x="10" y="70" width="20" height="20" />
                            <rect x="70" y="70" width="20" height="20" />
                        </svg>
                    </div>
                    <h2 class="process-title" id="processTitle">Scanning Image</h2>
                    <p class="process-subtitle" id="processSubtitle">Hold steady for best results</p>
                    
                    <div class="process-steps">
                        <div class="step" id="step1">
                            <div class="step-icon">üì∏</div>
                            <span class="step-label">Capture</span>
                        </div>
                        <div class="step" id="step2">
                            <div class="step-icon">üîç</div>
                            <span class="step-label">Extract</span>
                        </div>
                        <div class="step" id="step3">
                            <div class="step-icon">üß†</div>
                            <span class="step-label">Solve</span>
                        </div>
                        <div class="step" id="step4">
                            <div class="step-icon">‚úÖ</div>
                            <span class="step-label">Result</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar" id="statusBar">
        <span id="statusText">Welcome! Add your API keys to get started.</span>
    </div>

    <div class="actions">
        <button id="startBtn" class="success" disabled>
            <span>Start Scanning</span>
        </button>
        <button id="stopBtn" disabled>
            <span>Stop</span>
        </button>
    </div>
</div>

<div class="results-panel" id="resultsPanel">
    <div class="results-header">
        <h3>Recent Results</h3>
        <button class="icon-button secondary" id="closeResults">‚úï</button>
    </div>
    <div class="results-content" id="resultsContent">
        <!-- Results will be added here -->
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// Enhanced Professional Vision AI Application
const $ = id => document.getElementById(id);

// Application State
const App = {
    // API Keys
    openaiKey: '',
    geminiKey: '',
    
    // Camera State
    stream: null,
    videoTrack: null,
    cameras: [],
    selectedCamera: null,
    currentZoom: 1,
    
    // Processing State
    isProcessing: false,
    processInterval: null,
    currentStep: 0,
    
    // Results History
    history: [],
    
    // Settings
    quality: 'high',
    scanInterval: 5000, // 5 seconds between scans
    
    // Audio
    audioContext: null,
    sounds: {}
};

// Initialize Audio System
async function initAudio() {
    if (typeof Tone === 'undefined') return;
    
    try {
        await Tone.start();
        
        App.sounds.capture = new Tone.Synth({
            oscillator: { type: 'sine' },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 }
        }).toDestination();
        
        App.sounds.success = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: 'triangle' },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.3 }
        }).toDestination();
        
        App.sounds.error = new Tone.Synth({
            oscillator: { type: 'sawtooth' },
            envelope: { attack: 0.02, decay: 0.3, sustain: 0, release: 0.1 }
        }).toDestination();
        
        App.sounds.processing = new Tone.AMSynth({
            harmonicity: 2,
            oscillator: { type: 'sine' },
            envelope: { attack: 0.01, decay: 0.01, sustain: 0.5, release: 0.01 }
        }).toDestination();
        
    } catch (e) {
        console.error('Audio initialization failed:', e);
    }
}

// Play Sound Effect
function playSound(name) {
    if (!App.sounds[name]) return;
    
    const now = Tone.now();
    try {
        switch(name) {
            case 'capture':
                App.sounds.capture.triggerAttackRelease('C5', '8n', now);
                break;
            case 'success':
                App.sounds.success.triggerAttackRelease(['C5', 'E5', 'G5'], '4n', now);
                break;
            case 'error':
                App.sounds.error.triggerAttackRelease('C3', '4n', now);
                break;
            case 'processing':
                App.sounds.processing.triggerAttackRelease('A4', '16n', now);
                break;
        }
    } catch (e) {
        console.error('Sound playback error:', e);
    }
}

// Toast Notification System
function showToast(title, message, type = 'info', duration = 4000) {
    const toast = document.createElement('div');
    toast.className = `toast ${type} fade-in`;
    
    const icons = {
        info: '‚ÑπÔ∏è',
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è'
    };
    
    toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
    `;
    
    $('toastContainer').appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, duration);
    
    if (type === 'success') playSound('success');
    else if (type === 'error') playSound('error');
}

// Update Status Bar
function updateStatus(text, type = 'info') {
    const statusBar = $('statusBar');
    const statusText = $('statusText');
    
    statusBar.className = 'status-bar';
    if (type === 'success') statusBar.classList.add('success');
    else if (type === 'error') statusBar.classList.add('error');
    
    statusText.textContent = text;
}

// Update Process Step
function updateProcessStep(step) {
    for (let i = 1; i <= 4; i++) {
        $(`step${i}`).classList.toggle('active', i === step);
    }
    
    const titles = [
        'Preparing Camera',
        'Capturing Image',
        'Extracting Question',
        'Solving Problem',
        'Processing Complete'
    ];
    
    const subtitles = [
        'Getting ready...',
        'Hold steady for best results',
        'Using AI to read the question',
        'Advanced AI solving the problem',
        'Answer ready!'
    ];
    
    $('processTitle').textContent = titles[step] || titles[0];
    $('processSubtitle').textContent = subtitles[step] || subtitles[0];
}

// Load API Keys from Storage
function loadAPIKeys() {
    try {
        App.openaiKey = localStorage.getItem('visionai_openai_key') || '';
        App.geminiKey = localStorage.getItem('visionai_gemini_key') || '';
        
        if (App.openaiKey) {
            $('openaiKeyEntry').classList.add('hidden');
            $('openaiKeyDisplay').classList.remove('hidden');
            $('openaiKeyText').textContent = `Key: ${App.openaiKey.slice(0, 7)}‚Ä¢‚Ä¢‚Ä¢‚Ä¢${App.openaiKey.slice(-4)}`;
        }
        
        if (App.geminiKey) {
            $('geminiKeyEntry').classList.add('hidden');
            $('geminiKeyDisplay').classList.remove('hidden');
            $('geminiKeyText').textContent = `Key: ${App.geminiKey.slice(0, 7)}‚Ä¢‚Ä¢‚Ä¢‚Ä¢${App.geminiKey.slice(-4)}`;
        }
        
        updateUI();
    } catch (e) {
        console.error('Failed to load API keys:', e);
    }
}

// Save API Keys
function saveOpenAIKey() {
    const key = $('openaiKey').value.trim();
    if (!key.startsWith('sk-')) {
        showToast('Invalid Key', 'OpenAI key must start with "sk-"', 'error');
        return;
    }
    
    App.openaiKey = key;
    localStorage.setItem('visionai_openai_key', key);
    
    $('openaiKeyEntry').classList.add('hidden');
    $('openaiKeyDisplay').classList.remove('hidden');
    $('openaiKeyText').textContent = `Key: ${key.slice(0, 7)}‚Ä¢‚Ä¢‚Ä¢‚Ä¢${key.slice(-4)}`;
    
    showToast('Success', 'OpenAI API key saved', 'success');
    updateUI();
    
    if (App.openaiKey && App.geminiKey && !App.stream) {
        initCamera();
    }
}

function saveGeminiKey() {
    const key = $('geminiKey').value.trim();
    if (!key) {
        showToast('Invalid Key', 'Please enter a valid Google AI key', 'error');
        return;
    }
    
    App.geminiKey = key;
    localStorage.setItem('visionai_gemini_key', key);
    
    $('geminiKeyEntry').classList.add('hidden');
    $('geminiKeyDisplay').classList.remove('hidden');
    $('geminiKeyText').textContent = `Key: ${key.slice(0, 7)}‚Ä¢‚Ä¢‚Ä¢‚Ä¢${key.slice(-4)}`;
    
    showToast('Success', 'Google AI API key saved', 'success');
    updateUI();
    
    if (App.openaiKey && App.geminiKey && !App.stream) {
        initCamera();
    }
}

// Camera Initialization
async function initCamera() {
    try {
        updateStatus('Initializing camera...', 'info');
        
        // Get camera permissions
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop());
        
        // Enumerate devices
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        
        if (videoDevices.length === 0) {
            throw new Error('No cameras found');
        }
        
        App.cameras = videoDevices;
        
        // Populate camera select
        const cameraSelect = $('cameraSelect');
        cameraSelect.innerHTML = '';
        
        videoDevices.forEach((device, index) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.textContent = device.label || `Camera ${index + 1}`;
            cameraSelect.appendChild(option);
        });
        
        // Select back camera if available
        const backCamera = videoDevices.find(d => 
            d.label.toLowerCase().includes('back') || 
            d.label.toLowerCase().includes('environment')
        );
        
        if (backCamera) {
            cameraSelect.value = backCamera.deviceId;
        }
        
        App.selectedCamera = cameraSelect.value;
        
        // Start camera stream
        await startCamera();
        
        $('cameraControls').classList.remove('hidden');
        updateStatus('Camera ready! You can start scanning.', 'success');
        
    } catch (error) {
        console.error('Camera initialization failed:', error);
        updateStatus('Camera access denied or not available', 'error');
        showToast('Camera Error', error.message, 'error');
    }
}

// Start Camera Stream
async function startCamera() {
    try {
        if (App.stream) {
            App.stream.getTracks().forEach(track => track.stop());
        }
        
        const constraints = {
            video: {
                deviceId: App.selectedCamera ? { exact: App.selectedCamera } : undefined,
                width: { ideal: 1920 },
                height: { ideal: 1440 },
                aspectRatio: { ideal: 4/3 }
            }
        };
        
        App.stream = await navigator.mediaDevices.getUserMedia(constraints);
        App.videoTrack = App.stream.getVideoTracks()[0];
        
        const video = $('videoPreview');
        video.srcObject = App.stream;
        
        // Setup zoom if supported
        const capabilities = App.videoTrack.getCapabilities();
        if (capabilities.zoom) {
            const zoomSlider = $('zoomSlider');
            zoomSlider.min = capabilities.zoom.min || 1;
            zoomSlider.max = capabilities.zoom.max || 10;
            zoomSlider.value = App.currentZoom;
            $('zoomControl').style.display = 'flex';
        } else {
            $('zoomControl').style.display = 'none';
        }
        
    } catch (error) {
        console.error('Failed to start camera:', error);
        throw error;
    }
}

// Capture Image from Video
function captureImage() {
    const video = $('videoPreview');
    const canvas = document.createElement('canvas');
    
    // Set quality based on setting
    const scale = App.quality === 'high' ? 1 : App.quality === 'medium' ? 0.75 : 0.5;
    
    canvas.width = video.videoWidth * scale;
    canvas.height = video.videoHeight * scale;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    playSound('capture');
    
    return canvas.toDataURL('image/jpeg', 0.9);
}

// Extract Question using OpenAI
async function extractQuestion(imageData) {
    updateProcessStep(2);
    updateStatus('Extracting question from image...', 'info');
    
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${App.openaiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [
                    {
                        role: 'system',
                        content: 'You are an expert at extracting questions from images. Focus on the most prominent, complete question visible in the center of the image. Ignore partial questions, laptop screens, or questions at the edges. Extract the question text exactly as it appears, including any multiple choice options if present. If no clear question is found, respond with "NO_QUESTION_FOUND".'
                    },
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: 'Extract the main question from this image. Include all options if it\'s a multiple choice question.'
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: imageData,
                                    detail: 'high'
                                }
                            }
                        ]
                    }
                ],
                max_tokens: 1000,
                temperature: 0.1
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || 'OpenAI API error');
        }
        
        const data = await response.json();
        const extractedText = data.choices[0].message.content.trim();
        
        if (extractedText === 'NO_QUESTION_FOUND') {
            throw new Error('No clear question found in image');
        }
        
        console.log('Extracted question:', extractedText);
        return extractedText;
        
    } catch (error) {
        console.error('Question extraction failed:', error);
        throw error;
    }
}

// Solve Question using Gemini
async function solveQuestion(questionText) {
    updateProcessStep(3);
    updateStatus('Solving question with advanced AI...', 'info');
    
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${App.geminiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: `You are an expert problem solver specializing in reinforcement learning and academic questions. 

Given the following question, provide:
1. The correct answer (if multiple choice, specify the letter/option)
2. A brief explanation of why it's correct
3. Key concepts involved

Question:
${questionText}

Format your response as:
ANSWER: [Your answer here]
EXPLANATION: [Brief explanation]
CONCEPTS: [Key concepts]`
                    }]
                }],
                generationConfig: {
                    temperature: 0.1,
                    maxOutputTokens: 2048,
                }
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || 'Gemini API error');
        }
        
        const data = await response.json();
        const solution = data.candidates[0].content.parts[0].text;
        
        return parseSolution(solution);
        
    } catch (error) {
        console.error('Question solving failed:', error);
        throw error;
    }
}

// Parse Solution Response
function parseSolution(solutionText) {
    const lines = solutionText.split('\n');
    let answer = '';
    let explanation = '';
    let concepts = '';
    
    for (const line of lines) {
        if (line.startsWith('ANSWER:')) {
            answer = line.replace('ANSWER:', '').trim();
        } else if (line.startsWith('EXPLANATION:')) {
            explanation = line.replace('EXPLANATION:', '').trim();
        } else if (line.startsWith('CONCEPTS:')) {
            concepts = line.replace('CONCEPTS:', '').trim();
        }
    }
    
    return { answer, explanation, concepts };
}

// Process Single Scan
async function processScan() {
    if (!App.isProcessing) return;
    
    try {
        // Show process overlay
        $('processOverlay').classList.add('active');
        
        // Step 1: Capture
        updateProcessStep(1);
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const imageData = captureImage();
        
        // Step 2: Extract Question
        const questionText = await extractQuestion(imageData);
        
        // Step 3: Solve Question
        const solution = await solveQuestion(questionText);
        
        // Step 4: Complete
        updateProcessStep(4);
        playSound('success');
        
        // Add to history
        const result = {
            timestamp: new Date(),
            question: questionText,
            answer: solution.answer,
            explanation: solution.explanation,
            concepts: solution.concepts
        };
        
        App.history.unshift(result);
        addResultToPanel(result);
        
        // Show success message
        updateStatus(`Answer: ${solution.answer}`, 'success');
        showToast('Solution Found!', solution.answer, 'success', 6000);
        
        // Speak answer
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(`The answer is ${solution.answer}`);
            speechSynthesis.speak(utterance);
        }
        
        // Hide overlay after showing result
        setTimeout(() => {
            $('processOverlay').classList.remove('active');
        }, 2000);
        
    } catch (error) {
        console.error('Scan processing failed:', error);
        $('processOverlay').classList.remove('active');
        updateStatus('Failed to process image', 'error');
        showToast('Processing Failed', error.message, 'error');
    }
    
    // Schedule next scan
    if (App.isProcessing) {
        App.processInterval = setTimeout(processScan, App.scanInterval);
    }
}

// Add Result to History Panel
function addResultToPanel(result) {
    const resultItem = document.createElement('div');
    resultItem.className = 'result-item fade-in';
    
    const timeStr = result.timestamp.toLocaleTimeString();
    
    resultItem.innerHTML = `
        <div class="result-time">${timeStr}</div>
        <div class="result-question">${result.question.substring(0, 100)}${result.question.length > 100 ? '...' : ''}</div>
        <div class="result-answer">${result.answer}</div>
        ${result.explanation ? `<div class="result-explanation">${result.explanation}</div>` : ''}
    `;
    
    const container = $('resultsContent');
    container.insertBefore(resultItem, container.firstChild);
    
    // Keep only last 10 results
    while (container.children.length > 10) {
        container.removeChild(container.lastChild);
    }
}

// Start Processing
function startProcessing() {
    if (!App.openaiKey || !App.geminiKey || !App.stream) {
        showToast('Not Ready', 'Please add API keys and allow camera access', 'warning');
        return;
    }
    
    App.isProcessing = true;
    updateUI();
    updateStatus('Scanning for questions...', 'info');
    playSound('processing');
    
    // Start first scan immediately
    processScan();
}

// Stop Processing
function stopProcessing() {
    App.isProcessing = false;
    clearTimeout(App.processInterval);
    $('processOverlay').classList.remove('active');
    updateStatus('Scanning stopped', 'info');
    updateUI();
}

// Update UI State
function updateUI() {
    const ready = App.openaiKey && App.geminiKey && App.stream;
    
    $('startBtn').disabled = !ready || App.isProcessing;
    $('stopBtn').disabled = !App.isProcessing;
    
    if (ready && !App.isProcessing) {
        updateStatus('Ready to scan! Point camera at question.', 'success');
    }
}

// Event Listeners
$('saveOpenAIKey').addEventListener('click', saveOpenAIKey);
$('saveGeminiKey').addEventListener('click', saveGeminiKey);

$('changeOpenAIKey').addEventListener('click', () => {
    $('openaiKeyEntry').classList.remove('hidden');
    $('openaiKeyDisplay').classList.add('hidden');
    $('openaiKey').value = App.openaiKey;
    $('openaiKey').focus();
});

$('changeGeminiKey').addEventListener('click', () => {
    $('geminiKeyEntry').classList.remove('hidden');
    $('geminiKeyDisplay').classList.add('hidden');
    $('geminiKey').value = App.geminiKey;
    $('geminiKey').focus();
});

$('cameraSelect').addEventListener('change', (e) => {
    App.selectedCamera = e.target.value;
    if (App.stream) {
        startCamera();
    }
});

$('zoomSlider').addEventListener('input', (e) => {
    App.currentZoom = parseFloat(e.target.value);
    $('zoomValue').textContent = `${App.currentZoom.toFixed(1)}x`;
    
    if (App.videoTrack) {
        App.videoTrack.applyConstraints({
            advanced: [{ zoom: App.currentZoom }]
        }).catch(console.error);
    }
});

$('qualitySelect').addEventListener('change', (e) => {
    App.quality = e.target.value;
    showToast('Quality Changed', `Image quality set to ${App.quality}`, 'info');
});

$('startBtn').addEventListener('click', () => {
    initAudio();
    startProcessing();
});

$('stopBtn').addEventListener('click', stopProcessing);

$('historyBtn').addEventListener('click', () => {
    $('resultsPanel').classList.add('active');
});

$('closeResults').addEventListener('click', () => {
    $('resultsPanel').classList.remove('active');
});

// Enter key support for API inputs
$('openaiKey').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') saveOpenAIKey();
});

$('geminiKey').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') saveGeminiKey();
});

// Handle visibility changes
document.addEventListener('visibilitychange', () => {
    if (document.hidden && App.isProcessing) {
        stopProcessing();
    }
});

// Initialize on load
window.addEventListener('load', () => {
    loadAPIKeys();
    
    if (App.openaiKey && App.geminiKey) {
        initCamera();
    }
});

// Cleanup on unload
window.addEventListener('beforeunload', () => {
    if (App.stream) {
        App.stream.getTracks().forEach(track => track.stop());
    }
});
</script>
</body>
</html>